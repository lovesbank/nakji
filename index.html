<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>낙지잡이</title>
  <style>
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 680px;
      margin: 22px auto;
      padding: 0 14px;
      line-height: 1.6;
    }
    h1{ font-size: 22px; text-align:center; margin: 8px 0 14px; }

    .card{
      background:#f5f5f7;
      border:1px solid #e5e5ea;
      border-radius:14px;
      padding:14px;
      margin-bottom: 12px;
    }

    label{ display:block; margin-top:10px; font-size:14px; }
    input{
      width:100%;
      padding:10px;
      margin-top:6px;
      border:1px solid #d1d1d6;
      border-radius:12px;
      font-size:16px;
      box-sizing:border-box;
      background:#fff;
    }
    .row{ display:flex; gap:10px; }
    .row > div{ flex:1; }

    button{
      width:100%;
      padding:12px;
      margin-top:12px;
      border:0;
      border-radius:14px;
      font-size:16px;
    }
    .primary{ background:#007aff;color:#fff; }
    .secondary{ background:#111;color:#fff; }
    .ghost{ background:#fff;border:1px solid #d1d1d6; }

    .btnRow{ display:flex; gap:10px; margin-top:12px; }
    .btnRow button{ margin-top:0; width:100%; }

    .result{
      margin-top:14px;
      white-space:pre-line;
      background:#fff;
      border:1px solid #e5e5ea;
      border-radius:14px;
      padding:12px;
      user-select:text;
      -webkit-user-select:text;
    }
    .hint{
      font-size:12px;
      color:#666;
      margin-top:8px;
    }

    .sectionTitle{
      font-size:15px;
      font-weight:700;
      margin: 2px 0 8px;
    }

    .historyList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .historyItem{
      background:#fff;
      border:1px solid #e5e5ea;
      border-radius:14px;
      padding:12px;
    }
    .historyTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .tag{
      font-size:12px;
      color:#444;
      background:#f2f2f7;
      border:1px solid #e5e5ea;
      padding:4px 8px;
      border-radius:999px;
      display:inline-block;
      max-width: 72%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .miniBtn{
      font-size:13px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid #d1d1d6;
      background:#fff;
      width:auto;
      margin:0;
    }
    .miniRow{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .muted{ color:#777; font-size:12px; }
    .strong{ font-weight:700; }
  </style>
</head>

<body>
  <h1>낙지잡이</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>정산 메모(선택)</label>
        <input type="text" id="memo" placeholder="예: 12/30 여수 1차" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>낙지 (kg)</label>
        <input type="number" id="kg" inputmode="decimal" placeholder="예: 12" />
      </div>
      <div>
        <label>단가 (원)</label>
        <!-- 콤마 자동 입력 -->
        <input type="text" id="price" inputmode="numeric" placeholder="예: 35,000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>입감 (박스)</label>
        <input type="number" id="box" inputmode="numeric" placeholder="예: 2" />
      </div>
      <div>
        <label>기름값 (원)</label>
        <!-- 콤마 자동 입력 -->
        <input type="text" id="fuel" inputmode="numeric" placeholder="예: 150,000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>부식 (원)</label>
        <!-- 콤마 자동 입력 -->
        <input type="text" id="food" inputmode="numeric" placeholder="예: 50,000" />
      </div>
      <div>
        <label>나누기 (기본 4.5)</label>
        <input type="number" id="divideBy" inputmode="decimal" value="4.5" />
      </div>
    </div>

    <button class="primary" id="calcBtn">계산하기</button>

    <div class="btnRow">
      <button class="secondary" id="copyBtn">카톡으로 보내기(복사)</button>
      <button class="ghost" id="saveBtn">이 정산 저장</button>
    </div>

    <div class="result" id="result">값 입력 → 계산하기</div>
    <div class="hint">※ 저장은 이 폰/브라우저에만 저장돼. 카톡 버튼은 정산문을 복사해줘.</div>
  </div>

  <div class="card">
    <div class="historyTop">
      <div>
        <div class="sectionTitle">저장된 정산</div>
        <div class="muted">※ 최대 50개까지 저장</div>
      </div>
      <button class="miniBtn" id="clearAllBtn">전체 삭제</button>
    </div>

    <div class="historyList" id="historyList">
      <div class="muted">아직 저장된 정산이 없어.</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const STORAGE_KEY = "nakji_settlements_v2";
    let kakaoText = "";
    let lastCalc = null;

    // ---------- 숫자 처리 ----------
    function num(v){
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    }

    // 콤마 제거 후 숫자 변환
    function uncomma(v){
      const s = String(v ?? "").replace(/,/g, "").trim();
      if (!s) return 0;
      // 숫자/소수점/음수만 남김
      const clean = s.replace(/[^\d.-]/g, "");
      return Number(clean) || 0;
    }

    // 원 단위 표시(천단위 콤마)
    function won(x){
      return Math.round(x).toLocaleString("ko-KR") + "원";
    }

    // 입력창 콤마 자동
    // - 숫자만 허용
    // - 입력 중 천 단위 콤마 적용
    function attachCommaInput(el){
      if (!el) return;

      el.addEventListener("input", () => {
        const raw = el.value.replace(/,/g, "").replace(/[^\d]/g, "");
        if (!raw) { el.value = ""; return; }
        el.value = Number(raw).toLocaleString("ko-KR");
      });

      // 붙여넣기/한글키보드 등으로 이상값 들어오는 경우 방어
      el.addEventListener("blur", () => {
        const raw = el.value.replace(/,/g, "").replace(/[^\d]/g, "");
        if (!raw) { el.value = ""; return; }
        el.value = Number(raw).toLocaleString("ko-KR");
      });
    }

    function nowLabel(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    // ---------- 텍스트 생성 ----------
    function buildText(calc){
      const {
        kg, price, box, fuel, food, divideBy,
        boxUnit, feeRate,
        nakjiTotal, boxCost, coopFee, totalCost, finalTotal, perShare,
        memo, createdAt
      } = calc;

      const memoLine = memo ? `메모: ${memo}\n` : "";
      const timeLine = createdAt ? `시간: ${createdAt}\n` : "";

      return `[낙지잡이 정산]
${timeLine}${memoLine}
낙지: ${kg}kg × ${Math.round(price).toLocaleString("ko-KR")}원 = ${won(nakjiTotal)}

[경비]
입감: ${box}박스 × ${boxUnit.toLocaleString("ko-KR")}원 = ${won(boxCost)}
기름값: ${won(fuel)}
수협수수료: 낙지 총합의 5% = ${won(coopFee)}
부식: ${won(food)}

최종합계: 낙지총합 - 경비(입감+기름값+수협수수료+부식) = ${won(finalTotal)}
최종합계 나누기 ${divideBy} = ${won(perShare)}`;
    }

    // ---------- 계산 ----------
    function calculate(){
      const memo = $("memo").value.trim();

      const kg = num($("kg").value);
      const price = uncomma($("price").value); // 콤마 입력값
      const box = num($("box").value);
      const fuel = uncomma($("fuel").value);   // 콤마 입력값
      const food = uncomma($("food").value);   // 콤마 입력값
      const divideBy = num($("divideBy").value) || 1;

      const boxUnit = 60000;
      const feeRate = 0.05;

      const nakjiTotal = kg * price;
      const boxCost = box * boxUnit;
      const coopFee = nakjiTotal * feeRate;

      const totalCost = boxCost + fuel + coopFee + food;
      const finalTotal = nakjiTotal - totalCost;
      const perShare = finalTotal / divideBy;

      const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (String(Date.now()) + "_" + Math.random().toString(16).slice(2));

      lastCalc = {
        id,
        createdAt: nowLabel(),
        memo,
        kg, price, box, fuel, food, divideBy,
        boxUnit, feeRate,
        nakjiTotal, boxCost, coopFee, totalCost, finalTotal, perShare
      };

      kakaoText = buildText(lastCalc);
      $("result").innerText = kakaoText;
    }

    // ---------- 복사 ----------
    async function copyKakao(){
      if (!kakaoText) calculate();
      if (!kakaoText){
        alert("값을 입력하고 계산해줘.");
        return;
      }
      try{
        await navigator.clipboard.writeText(kakaoText);
        alert("복사 완료! 카톡에서 붙여넣기만 하면 돼.");
      }catch(e){
        alert("자동 복사가 막혔어. 아래 정산문을 길게 눌러서 전체 선택 후 복사해줘.");
      }
    }

    // ---------- 저장소 ----------
    function loadHistory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function saveHistory(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function saveCurrent(){
      if (!lastCalc) calculate();
      if (!lastCalc){
        alert("값을 입력하고 계산한 뒤 저장해줘.");
        return;
      }

      const list = loadHistory();
      list.unshift(lastCalc);
      saveHistory(list.slice(0, 50));
      renderHistory();
      alert("저장 완료!");
    }

    function deleteOne(id){
      const list = loadHistory().filter(x => x && x.id !== id);
      saveHistory(list);
      renderHistory();
    }

    function clearAll(){
      const ok = confirm("저장된 정산을 전부 삭제할까?");
      if (!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
    }

    function fillFormFrom(calc){
      $("memo").value = calc.memo || "";
      $("kg").value = (calc.kg ?? "");
      $("price").value = (Math.round(calc.price ?? 0)).toLocaleString("ko-KR");
      $("box").value = (calc.box ?? "");
      $("fuel").value = (Math.round(calc.fuel ?? 0)).toLocaleString("ko-KR");
      $("food").value = (Math.round(calc.food ?? 0)).toLocaleString("ko-KR");
      $("divideBy").value = (calc.divideBy ?? 4.5);

      lastCalc = calc;
      kakaoText = buildText(calc);
      $("result").innerText = kakaoText;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function renderHistory(){
      const list = loadHistory();
      const wrap = $("historyList");

      if (!list.length){
        wrap.innerHTML = `<div class="muted">아직 저장된 정산이 없어.</div>`;
        return;
      }

      wrap.innerHTML = "";
      list.forEach((item) => {
        const title = item.memo ? item.memo : "정산";
        const time = item.createdAt ? item.createdAt : "";
        const summary = `최종합계 ${won(item.finalTotal)} / 나누기 ${item.divideBy} = ${won(item.perShare)}`;

        const el = document.createElement("div");
        el.className = "historyItem";
        el.innerHTML = `
          <div class="historyTop">
            <div>
              <div class="tag">${title}</div>
              <div class="muted" style="margin-top:6px;">${time}</div>
              <div class="strong" style="margin-top:6px;">${summary}</div>
            </div>
          </div>
          <div class="miniRow">
            <button class="miniBtn" data-act="load" data-id="${item.id}">불러오기</button>
            <button class="miniBtn" data-act="copy" data-id="${item.id}">복사</button>
            <button class="miniBtn" data-act="del" data-id="${item.id}">삭제</button>
          </div>
        `;
        wrap.appendChild(el);
      });

      wrap.onclick = async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        const list2 = loadHistory();
        const found = list2.find(x => x && x.id === id);
        if (!found) return;

        if (act === "load"){
          fillFormFrom(found);
        } else if (act === "del"){
          deleteOne(id);
        } else if (act === "copy"){
          const text = buildText(found);
          try{
            await navigator.clipboard.writeText(text);
            alert("복사 완료! 카톡에 붙여넣기만 하면 돼.");
          }catch(e2){
            alert("자동 복사가 막혔어. 불러오기 후 결과창을 길게 눌러 복사해줘.");
          }
        }
      };
    }

    // ---------- 이벤트 ----------
    $("calcBtn").addEventListener("click", calculate);
    $("copyBtn").addEventListener("click", copyKakao);
    $("saveBtn").addEventListener("click", saveCurrent);
    $("clearAllBtn").addEventListener("click", clearAll);

    // Enter로 계산
    ["memo","kg","price","box","fuel","food","divideBy"].forEach(id=>{
      $(id).addEventListener("keydown", (e)=>{ if(e.key==="Enter") calculate(); });
    });

    // 콤마 자동 적용
    attachCommaInput($("price"));
    attachCommaInput($("fuel"));
    attachCommaInput($("food"));

    // 첫 로드
    renderHistory();
  </script>
</body>
</html>
