<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë‚™ì§€ì¡ì´</title>

  <!-- PWA(í™ˆí™”ë©´ ì¶”ê°€) ê¸°ë³¸ -->
  <meta name="theme-color" content="#0a84ff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <style>
    :root{
      --bg:#f2f2f7;
      --text:#111;
      --card:#f5f5f7;
      --card2:#fff;
      --line:#e5e5ea;
      --muted:#666;
      --muted2:#777;
      --primary:#007aff;
      --secondary:#111;
      --ghostBg:#fff;
      --ghostLine:#d1d1d6;
      --tagBg:#f2f2f7;
      --tagLine:#e5e5ea;
      --danger:#ff3b30;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#000;
        --text:#f5f5f7;
        --card:#101012;
        --card2:#16161a;
        --line:#2c2c2e;
        --muted:#a1a1a6;
        --muted2:#8e8e93;
        --primary:#0a84ff;
        --secondary:#f5f5f7;
        --ghostBg:#1c1c1e;
        --ghostLine:#3a3a3c;
        --tagBg:#1c1c1e;
        --tagLine:#3a3a3c;
        --danger:#ff453a;
      }
    }

    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 740px;
      margin: 22px auto;
      padding: 0 14px;
      line-height: 1.6;
      background: var(--bg);
      color: var(--text);
    }
    h1{ font-size: 22px; text-align:center; margin: 8px 0 14px; }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom: 12px;
    }
    .cardInner{
      background: var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }

    .titleSm{ font-weight:700; margin-top:8px; }
    .sectionTitle{ font-size:15px; font-weight:700; margin: 2px 0 8px; }

    label{ display:block; margin-top:10px; font-size:14px; color:var(--text); }
    input, select{
      width:100%;
      padding:10px;
      margin-top:6px;
      border:1px solid var(--ghostLine);
      border-radius:12px;
      font-size:16px;
      background: var(--ghostBg);
      color: var(--text);
      outline:none;
    }
    input:disabled{ opacity:0.6; }

    .row{ display:flex; gap:10px; }
    .row > div{ flex:1; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    button{
      width:100%;
      padding:12px;
      margin-top:12px;
      border:0;
      border-radius:14px;
      font-size:16px;
      background: var(--ghostBg);
      color: var(--text);
    }
    button:disabled{ opacity:0.6; }

    .primary{ background: var(--primary); color:#fff; }
    .secondary{ background: var(--secondary); color:#fff; }
    @media (prefers-color-scheme: dark){
      .secondary{ background: #f5f5f7; color:#000; }
    }

    .ghost{ background: var(--ghostBg); border:1px solid var(--ghostLine); }

    .btnRow{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .btnRow button{ margin-top:0; width:100%; }
    .btnRow.three button{ width: calc(33.333% - 6.66px); }
    .btnRow.two button{ width: calc(50% - 5px); }

    .result{
      margin-top:14px;
      white-space:pre-line;
      background: var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      user-select:text;
      -webkit-user-select:text;
    }

    .muted{ color:var(--muted2); font-size:12px; }
    .strong{ font-weight:700; }

    .historyList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .historyItem{
      background: var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .historyTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .tag{
      font-size:12px;
      color:var(--text);
      background: var(--tagBg);
      border:1px solid var(--tagLine);
      padding:4px 8px;
      border-radius:999px;
      display:inline-block;
      max-width: 72%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .miniBtn{
      font-size:13px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--ghostLine);
      background: var(--ghostBg);
      width:auto;
      margin:0;
    }
    .miniRow{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:10px;
      flex-wrap:wrap;
    }

    /* ê°œì¸ë‹¹ ê°•ì¡° ëª¨ë“œ */
    .bigPerShare .result{ font-size:15px; }
    .bigPerShare .perShareLine{
      font-size:22px;
      font-weight:900;
      line-height:1.3;
      padding-top:6px;
    }

    /* ì ê¸ˆ ìƒíƒœ UI */
    .lockedBadge{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--card2);
      font-size:12px;
      color: var(--muted);
    }

    /* ê°œì¸ë‹¹(Ã·) ìŠ¤í…í¼ */
    .stepper{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:6px;
    }
    .stepBtn{
      width:44px;
      min-width:44px;
      padding:10px 0;
      margin:0;
      border-radius:12px;
      border:1px solid var(--ghostLine);
      background: var(--ghostBg);
      font-size:18px;
      line-height:1;
    }
    .stepper input{
      margin-top:0;
      text-align:center;
      font-weight:700;
    }

    /* âœ… ìƒë‹¨ 1ì¤„: ê°œì¸ë‹¹ ì´í•© */
    .topTotalLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .topTotalLabel{ font-weight:800; }
    .topTotalValue{
      font-weight:900;
      color: var(--danger);
      font-size:20px;
      white-space:nowrap;
    }

    /* ì¸ì‡„/PDF */
    @media print{
      body{ max-width:none; margin:0; padding:0; }
      .noPrint{ display:none !important; }
      .card{ border:none; background:transparent; }
      .result{ border:1px solid #999; }
    }
  </style>
</head>

<body>
  <h1>ë‚™ì§€ì¡ì´</h1>

  <!-- âœ… (ì¶”ê°€) ì €ì¥ëœ ì •ì‚° ê¸°ì¤€: ë‚ ì§œë³„ ê°œì¸ë‹¹ ëˆ„ì  â†’ ê·¸ê±¸ ì „ë¶€ ë”í•œ ê°œì¸ë‹¹ ì´í•© 1ì¤„ -->
  <div class="card">
    <div class="topTotalLine">
      <div class="topTotalLabel">ê°œì¸ë‹¹ ì´í•©</div>
      <div class="topTotalValue" id="sumAllPer">0ì›</div>
    </div>

    <div style="margin-top:10px; display:flex; justify-content:space-between; gap:10px; align-items:center;">
      <div class="lockedBadge" id="lockBadge" style="display:none;">ğŸ”’ ì ê¸ˆë¨</div>
      <div class="muted" id="calcTime"></div>
    </div>

    <div class="btnRow two noPrint">
      <button class="ghost" id="recentBtn">ìµœê·¼ 1ê±´ ë°”ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="ghost" id="toggleBigBtn">ê°œì¸ë‹¹ ê¸ˆì•¡ í¬ê²Œ ë³´ê¸°</button>
    </div>

    <div class="btnRow two noPrint">
      <button class="ghost" id="lockBtn">ê³„ì‚° ì ê¸ˆ</button>
      <button class="ghost" id="unlockBtn" style="display:none;">ì ê¸ˆ í•´ì œ</button>
    </div>
  </div>

  <!-- ì…ë ¥ ì¹´ë“œ -->
  <div class="card" id="inputCard">
    <div class="row">
      <div>
        <label>ì •ì‚° ë©”ëª¨(ì„ íƒ)</label>
        <input type="text" id="memo" placeholder="ì˜ˆ: 12/30 ì—¬ìˆ˜ 1ì°¨" />
      </div>
    </div>

    <div class="titleSm">ë‚™ì§€ 1</div>
    <div class="row">
      <div>
        <label>ë‚™ì§€1 (kg)</label>
        <input type="number" id="kg1" inputmode="decimal" placeholder="ì˜ˆ: 12" />
      </div>
      <div>
        <label>ë‹¨ê°€1 (ì›)</label>
        <input type="text" id="price1" inputmode="numeric" placeholder="ì˜ˆ: 35,000" />
      </div>
    </div>

    <div class="titleSm">ë‚™ì§€ 2</div>
    <div class="row">
      <div>
        <label>ë‚™ì§€2 (kg)</label>
        <input type="number" id="kg2" inputmode="decimal" placeholder="ì˜ˆ: 8" />
      </div>
      <div>
        <label>ë‹¨ê°€2 (ì›)</label>
        <input type="text" id="price2" inputmode="numeric" placeholder="ì˜ˆ: 40,000" />
      </div>
    </div>

    <div class="titleSm">ê²½ë¹„</div>

    <div class="row">
      <div>
        <label>ì…ê° (ë°•ìŠ¤)</label>
        <input type="number" id="iceBoxes" inputmode="numeric" placeholder="ì˜ˆ: 2" />
      </div>
      <div>
        <label>ì…ê° ë‹¨ê°€ (ì›)</label>
        <input type="text" id="iceUnit" inputmode="numeric" value="60,000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>ê¸°ë¦„ ìˆ˜ëŸ‰</label>
        <input type="number" id="fuelQty" inputmode="decimal" placeholder="ì˜ˆ: 3" />
      </div>
      <div>
        <label>ê¸°ë¦„ ë‹¨ê°€ (ì›)</label>
        <input type="text" id="fuelUnit" inputmode="numeric" value="200,000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>ë¶€ì‹ (ì›)</label>
        <input type="text" id="food" inputmode="numeric" placeholder="ì˜ˆ: 50,000" />
      </div>
      <div>
        <label>ê°œì¸ë‹¹ ë‚˜ëˆ„ê¸°</label>
        <div class="stepper noPrint">
          <button class="stepBtn" id="divDownBtn" type="button">âˆ’</button>
          <input type="number" id="divideBy" inputmode="decimal" step="0.5" value="4.5" />
          <button class="stepBtn" id="divUpBtn" type="button">+</button>
        </div>
      </div>
    </div>

    <button class="primary noPrint" id="calcBtn">ê³„ì‚°í•˜ê¸°</button>

    <div class="btnRow three noPrint">
      <button class="secondary" id="copyBtn">ì¹´í†¡ìœ¼ë¡œ ë³´ë‚´ê¸°(ë³µì‚¬)</button>
      <button class="ghost" id="saveBtn">ì´ ì •ì‚° ì €ì¥</button>
      <button class="ghost" id="pngBtn">ì´ë¯¸ì§€ ì €ì¥(PNG)</button>
    </div>

    <div class="btnRow two noPrint">
      <button class="ghost" id="kakaoImgBtn">ì¹´í†¡ìœ¼ë¡œ ì´ë¯¸ì§€ ë³´ë‚´ê¸°</button>
      <button class="ghost" id="pdfBtn">PDF ì €ì¥(ì¸ì‡„)</button>
    </div>

    <div class="btnRow two noPrint">
      <button class="ghost" id="xlsxBtn">ì—‘ì…€(.xlsx) ë‚´ë³´ë‚´ê¸°</button>
      <button class="ghost" id="imgCopyBtn">ì´ë¯¸ì§€ ë§í¬ ì—´ê¸°(í´ë°±)</button>
    </div>

    <div class="btnRow two noPrint">
      <button class="ghost" id="backupBtn">ë°±ì—…(JSON ì €ì¥)</button>
      <button class="ghost" id="restoreBtn">ë³µì›(JSON ë¶ˆëŸ¬ì˜¤ê¸°)</button>
    </div>

    <input type="file" id="restoreFile" accept="application/json" style="display:none;" />

    <div class="result" id="result">ê°’ ì…ë ¥ â†’ ê³„ì‚°í•˜ê¸°</div>
  </div>

  <!-- ì €ì¥ íˆìŠ¤í† ë¦¬ -->
  <div class="card">
    <div class="historyTop noPrint">
      <div>
        <div class="sectionTitle">ì €ì¥ëœ ì •ì‚°</div>
        <div class="muted">â€» ìµœëŒ€ 50ê°œê¹Œì§€ ì €ì¥</div>
      </div>
      <button class="miniBtn" id="clearAllBtn">ì „ì²´ ì‚­ì œ</button>
    </div>

    <div class="historyList" id="historyList">
      <div class="muted">ì•„ì§ ì €ì¥ëœ ì •ì‚°ì´ ì—†ì–´.</div>
    </div>
  </div>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬: XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬: PNG ìº¡ì²˜ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    const STORAGE_KEY = "nakji_settlements_final_split_v1";
    let kakaoText = "";
    let lastCalc = null;

    let bigPerShare = false;
    let locked = false;
    let lastImageDataUrl = "";

    function num(v){
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    }
    function uncomma(v){
      const s = String(v ?? "").replace(/,/g, "").trim();
      if (!s) return 0;
      const clean = s.replace(/[^\d.-]/g, "");
      return Number(clean) || 0;
    }
    function won(x){
      return Math.round(x).toLocaleString("ko-KR") + "ì›";
    }
    function nfmtInt(x){
      return Math.round(x).toLocaleString("ko-KR");
    }

    function attachCommaInput(el){
      if (!el) return;
      el.addEventListener("input", () => {
        if (locked) return;
        const raw = el.value.replace(/,/g, "").replace(/[^\d]/g, "");
        if (!raw) { el.value = ""; return; }
        el.value = Number(raw).toLocaleString("ko-KR");
      });
      el.addEventListener("blur", () => {
        if (locked) return;
        const raw = el.value.replace(/,/g, "").replace(/[^\d]/g, "");
        if (!raw) { el.value = ""; return; }
        el.value = Number(raw).toLocaleString("ko-KR");
      });
    }

    function nowLabel(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }
    function nowYMD(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}/${mm}/${dd}`;
    }

    // âœ… ë‚ ì§œí‚¤ ì¶”ì¶œ: memoì— ë‚ ì§œ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„ , ì—†ìœ¼ë©´ createdAt ë‚ ì§œ
    function extractDateKey(item){
      const memo = String(item?.memo || "");
      let m = memo.match(/(\d{4})[\/-](\d{2})[\/-](\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;

      const createdAt = String(item?.createdAt || "");
      m = createdAt.match(/(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;

      return "ê¸°íƒ€";
    }

    // âœ… ì €ì¥ëœ ì •ì‚°: ë‚ ì§œë³„ ê°œì¸ë‹¹ í•©ê³„ë¡œ ë¨¼ì € ë¬¶ê³  â†’ ê·¸ê±¸ ì „ë¶€ ë”í•œ ì´í•©
    function calcAllPerShareTotalFromHistory(){
      const list = loadHistory();
      const byDate = {};
      list.forEach(item => {
        const key = extractDateKey(item);
        const per = Number(item?.perShareRounded ?? item?.perShare ?? 0) || 0;
        byDate[key] = (byDate[key] || 0) + per;
      });

      let total = 0;
      Object.keys(byDate).forEach(k => total += byDate[k] || 0);
      return total;
    }

    function updateAllPerShareTotal(){
      $("sumAllPer").innerText = won(calcAllPerShareTotalFromHistory());
    }

    function ensureMemoDefault(){
      const m = $("memo").value.trim();
      if (!m) $("memo").value = `${nowYMD()} ì •ì‚°`;
    }

    // âœ… ê²°ê³¼ ë¬¸êµ¬ í˜•ì‹ ê¸°ëŠ¥ ì‚­ì œ: buildTextëŠ” 1ê°€ì§€ ê³ ì •(ì¹´í†¡ìš©)
    function buildText(calc){
      const memoLine = calc.memo ? `ë©”ëª¨: ${calc.memo}\n` : "";
      const timeLine = calc.createdAt ? `ì‹œê°„: ${calc.createdAt}\n` : "";
      const perLine = `ê°œì¸ë‹¹: ìµœì¢…í•©ê³„ Ã· ${calc.divideBy} = ${won(calc.perShareRounded)}`;

      return `[ë‚™ì§€ì¡ì´ ì •ì‚°]
${timeLine}${memoLine}
1) ë‚™ì§€: ${calc.kg1}kg Ã— ${nfmtInt(calc.price1)}ì› = ${won(calc.total1)}
2) ë‚™ì§€: ${calc.kg2}kg Ã— ${nfmtInt(calc.price2)}ì› = ${won(calc.total2)}
ë‚™ì§€ ì´í•©: ${won(calc.nakjiTotal)}

[ê²½ë¹„]
ì…ê°: ${calc.iceBoxes}ë°•ìŠ¤ Ã— ${nfmtInt(calc.iceUnit)}ì› = ${won(calc.iceCost)}
ê¸°ë¦„ê°’: ${calc.fuelQty} Ã— ${nfmtInt(calc.fuelUnit)}ì› = ${won(calc.fuelCost)}
ìˆ˜í˜‘ìˆ˜ìˆ˜ë£Œ: ë‚™ì§€ ì´í•©ì˜ 5% = ${won(calc.coopFee)}
ë¶€ì‹: ${won(calc.food)}
ì´ ê²½ë¹„: ${won(calc.totalCost)}

ìµœì¢…í•©ê³„: ${won(calc.finalTotal)}
${perLine}`;
    }

    function renderResult(calc){
      kakaoText = buildText(calc);

      const perLine = `ê°œì¸ë‹¹: ìµœì¢…í•©ê³„ Ã· ${calc.divideBy} = ${won(calc.perShareRounded)}`;
      $("result").innerHTML = "";

      const pre = document.createElement("div");
      pre.style.whiteSpace = "pre-line";
      pre.textContent = kakaoText.replace(perLine, "").trimEnd() + "\n";
      $("result").appendChild(pre);

      const perDiv = document.createElement("div");
      perDiv.className = "perShareLine";
      perDiv.textContent = perLine;
      $("result").appendChild(perDiv);
    }

    function calculate(){
      ensureMemoDefault();
      const memo = $("memo").value.trim();

      const kg1 = num($("kg1").value);
      const price1 = uncomma($("price1").value);
      const total1 = kg1 * price1;

      const kg2 = num($("kg2").value);
      const price2 = uncomma($("price2").value);
      const total2 = kg2 * price2;

      const nakjiTotal = total1 + total2;

      const iceBoxes = num($("iceBoxes").value);
      const iceUnit  = uncomma($("iceUnit").value) || 0;
      const iceCost  = iceBoxes * iceUnit;

      const fuelQty  = num($("fuelQty").value);
      const fuelUnit = uncomma($("fuelUnit").value) || 0;
      const fuelCost = fuelQty * fuelUnit;

      const food = uncomma($("food").value);
      const divideBy = num($("divideBy").value) || 1;

      const feeRate = 0.05;
      const coopFee = nakjiTotal * feeRate;

      const totalCost = iceCost + fuelCost + coopFee + food;
      const finalTotal = nakjiTotal - totalCost;
      const perShare = finalTotal / divideBy;

      // âœ… ê°œì¸ë‹¹ ë°˜ì˜¬ë¦¼ ê¸°ëŠ¥ ì‚­ì œ: ê·¸ëŒ€ë¡œ ì‚¬ìš©
      const perShareRounded = perShare;

      const id = (crypto && crypto.randomUUID)
        ? crypto.randomUUID()
        : (String(Date.now()) + "_" + Math.random().toString(16).slice(2));

      lastCalc = {
        id,
        createdAt: nowLabel(),
        memo,
        kg1, price1, total1,
        kg2, price2, total2,
        nakjiTotal,
        iceBoxes, iceUnit, iceCost,
        fuelQty, fuelUnit, fuelCost,
        food,
        feeRate, coopFee,
        totalCost,
        finalTotal,
        divideBy,
        perShare,
        perShareRounded
      };

      $("calcTime").innerText = lastCalc.createdAt ? `ê³„ì‚° ì‹œê°: ${lastCalc.createdAt.split(" ")[1]}` : "";

      renderResult(lastCalc);
      renderHistory();
    }

    async function copyKakao(){
      if (!lastCalc) calculate();
      if (!lastCalc) return;

      try{
        await navigator.clipboard.writeText(kakaoText);
        alert("ë³µì‚¬ ì™„ë£Œ!");
      }catch(e){
        alert("ìë™ ë³µì‚¬ê°€ ë§‰í˜”ì–´. ê²°ê³¼ì°½ì„ ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ë³µì‚¬í•´ì¤˜.");
      }
    }

    function savePDF(){
      if (!lastCalc) calculate();
      window.print();
    }

    function exportXLSX(){
      if (!lastCalc) calculate();
      if (!lastCalc) return;

      const rows = [
        ["í•­ëª©", "ìˆ˜ëŸ‰", "ë‹¨ê°€(ì›)", "ê¸ˆì•¡(ì›)"],
        ["ë‚™ì§€1", lastCalc.kg1, lastCalc.price1, Math.round(lastCalc.total1)],
        ["ë‚™ì§€2", lastCalc.kg2, lastCalc.price2, Math.round(lastCalc.total2)],
        ["ë‚™ì§€ì´í•©", "", "", Math.round(lastCalc.nakjiTotal)],
        ["", "", "", ""],
        ["ì…ê°(ë°•ìŠ¤)", lastCalc.iceBoxes, lastCalc.iceUnit, Math.round(lastCalc.iceCost)],
        ["ê¸°ë¦„", lastCalc.fuelQty, lastCalc.fuelUnit, Math.round(lastCalc.fuelCost)],
        ["ìˆ˜í˜‘ìˆ˜ìˆ˜ë£Œ(5%)", "", "", Math.round(lastCalc.coopFee)],
        ["ë¶€ì‹", "", "", Math.round(lastCalc.food)],
        ["ì´ê²½ë¹„", "", "", Math.round(lastCalc.totalCost)],
        ["", "", "", ""],
        ["ìµœì¢…í•©ê³„", "", "", Math.round(lastCalc.finalTotal)],
        ["ê°œì¸ë‹¹", lastCalc.divideBy, "", Math.round(lastCalc.perShareRounded)],
      ];

      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws["!cols"] = [{wch:18},{wch:10},{wch:14},{wch:14}];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ì •ì‚°");

      const nameSafe = (lastCalc.memo || "ì •ì‚°").replace(/[\\/:*?"<>|]/g, "_").slice(0, 30);
      XLSX.writeFile(wb, `ë‚™ì§€ì •ì‚°_${nameSafe}.xlsx`);
    }

    function makeCaptureTarget(){
      const target = document.createElement("div");
      target.style.padding = "14px";
      target.style.background = getComputedStyle(document.body).backgroundColor;

      // âœ… ê¸°ì¡´ summaryGrid clone ëŒ€ì‹ : ë§¨ ìœ„ ì¹´ë“œ(ê°œì¸ë‹¹ ì´í•© ì¹´ë“œ)ë¥¼ í†µì§¸ë¡œ ìº¡ì²˜
      const topClone = document.querySelector(".card").cloneNode(true);
      const inputClone = $("inputCard").cloneNode(true);

      topClone.querySelectorAll(".noPrint").forEach(el=>el.remove());
      inputClone.querySelectorAll(".noPrint").forEach(el=>el.remove());

      const rf = inputClone.querySelector("#restoreFile");
      if (rf) rf.remove();

      target.appendChild(topClone);
      target.appendChild(inputClone);

      target.style.position = "fixed";
      target.style.left = "-99999px";
      target.style.top = "0";
      document.body.appendChild(target);
      return target;
    }

    async function buildCanvas(){
      if (!lastCalc) calculate();
      if (!lastCalc) return null;

      const target = makeCaptureTarget();
      try{
        const canvas = await html2canvas(target, {
          scale: 2,
          backgroundColor: getComputedStyle(document.body).backgroundColor,
          useCORS: true
        });
        return canvas;
      } finally {
        target.remove();
      }
    }

    function safeFilename(){
      const nameSafe = (lastCalc?.memo || "ì •ì‚°")
        .replace(/[\\/:*?"<>|]/g, "_")
        .slice(0, 30);
      return `ë‚™ì§€ì •ì‚°_${nameSafe}.png`;
    }

    async function savePNG(){
      const canvas = await buildCanvas();
      if (!canvas) return;

      const filename = safeFilename();
      lastImageDataUrl = canvas.toDataURL("image/png");

      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      if (isIOS){
        const w = window.open();
        if (w){
          w.document.write(`<img src="${lastImageDataUrl}" style="max-width:100%;height:auto;">`);
          w.document.title = filename;
        } else {
          window.location.href = lastImageDataUrl;
        }
        return;
      }

      const a = document.createElement("a");
      a.href = lastImageDataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function shareToKakaoAsFile(){
      const canvas = await buildCanvas();
      if (!canvas) return;

      const filename = safeFilename();

      if (navigator.share && canvas.toBlob){
        const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
        if (blob){
          const file = new File([blob], filename, { type:"image/png" });

          if (!navigator.canShare || navigator.canShare({ files:[file] })){
            try{
              await navigator.share({
                title: "ë‚™ì§€ì¡ì´ ì •ì‚°",
                text: "ì •ì‚° ì´ë¯¸ì§€ íŒŒì¼",
                files: [file]
              });
              return;
            }catch(e){}
          }
        }
      }

      const dataUrl = canvas.toDataURL("image/png");
      lastImageDataUrl = dataUrl;
      const w = window.open();
      if (w){
        w.document.write(`<img src="${dataUrl}" style="max-width:100%;height:auto;">`);
        w.document.title = filename;
      } else {
        window.location.href = dataUrl;
      }
      alert("ê¸°ê¸°/ë¸Œë¼ìš°ì € ì œí•œìœ¼ë¡œ íŒŒì¼ ê³µìœ ê°€ ì•ˆ ë¼ì„œ, ì´ë¯¸ì§€ íƒ­ì„ ì—´ì—ˆì–´. ê³µìœ ì—ì„œ ì¹´í†¡ì„ ì„ íƒí•´ì¤˜(ë§í¬ë¡œ ê°ˆ ìˆ˜ë„ ìˆì–´).");
    }

    function openLastImage(){
      if (!lastImageDataUrl){
        alert("ì•„ì§ ë§Œë“  ì´ë¯¸ì§€ê°€ ì—†ì–´. ë¨¼ì € ì´ë¯¸ì§€ ì €ì¥(PNG) ë˜ëŠ” ì¹´í†¡ìœ¼ë¡œ ì´ë¯¸ì§€ ë³´ë‚´ê¸°ë¥¼ ëˆŒëŸ¬ì¤˜.");
        return;
      }
      const w = window.open();
      if (w){
        w.document.write(`<img src="${lastImageDataUrl}" style="max-width:100%;height:auto;">`);
      } else {
        window.location.href = lastImageDataUrl;
      }
    }

    function loadHistory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }
    function saveHistory(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function saveCurrent(){
      if (!lastCalc) calculate();
      if (!lastCalc) return;

      const list = loadHistory();
      list.unshift(lastCalc);
      saveHistory(list.slice(0, 50));
      renderHistory();
      updateAllPerShareTotal();
      alert("ì €ì¥ ì™„ë£Œ!");
    }

    function deleteOne(id){
      const list = loadHistory().filter(x => x && x.id !== id);
      saveHistory(list);
      renderHistory();
      updateAllPerShareTotal();
    }

    function clearAll(){
      const ok = confirm("ì €ì¥ëœ ì •ì‚°ì„ ì „ë¶€ ì‚­ì œí• ê¹Œ?");
      if (!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
      updateAllPerShareTotal();
    }

    function fillFormFrom(calc){
      $("memo").value = calc.memo || "";
      $("kg1").value = (calc.kg1 ?? "");
      $("price1").value = nfmtInt(calc.price1 ?? 0);

      $("kg2").value = (calc.kg2 ?? "");
      $("price2").value = nfmtInt(calc.price2 ?? 0);

      $("iceBoxes").value = (calc.iceBoxes ?? "");
      $("iceUnit").value = nfmtInt(calc.iceUnit ?? 0);

      $("fuelQty").value = (calc.fuelQty ?? "");
      $("fuelUnit").value = nfmtInt(calc.fuelUnit ?? 0);

      $("food").value = nfmtInt(calc.food ?? 0);
      $("divideBy").value = (calc.divideBy ?? 4.5);

      const per = (calc.perShareRounded ?? calc.perShare ?? 0);

      lastCalc = {
        ...calc,
        perShareRounded: per,
        totalCost: calc.totalCost ?? (calc.iceCost + calc.fuelCost + (calc.nakjiTotal*0.05) + calc.food),
        finalTotal: calc.finalTotal ?? (calc.nakjiTotal - (calc.iceCost + calc.fuelCost + (calc.nakjiTotal*0.05) + calc.food)),
      };

      $("calcTime").innerText = lastCalc.createdAt ? `ê³„ì‚° ì‹œê°: ${String(lastCalc.createdAt).split(" ")[1] || ""}` : "";

      renderResult(lastCalc);
      updateAllPerShareTotal();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function renderHistory(){
      const list = loadHistory();
      const wrap = $("historyList");

      if (!list.length){
        wrap.innerHTML = `<div class="muted">ì•„ì§ ì €ì¥ëœ ì •ì‚°ì´ ì—†ì–´.</div>`;
        return;
      }

      wrap.innerHTML = "";
      list.forEach((item) => {
        const title = item.memo ? item.memo : "ì •ì‚°";
        const time = item.createdAt ? item.createdAt : "";
        const per = (item.perShareRounded ?? item.perShare ?? 0);
        const summary = `ë‚™ì§€ì´í•© ${won(item.nakjiTotal)} / ìµœì¢… ${won(item.finalTotal)} / ê°œì¸ë‹¹ ${won(per)}`;

        const el = document.createElement("div");
        el.className = "historyItem";
        el.innerHTML = `
          <div class="historyTop">
            <div>
              <div class="tag">${title}</div>
              <div class="muted" style="margin-top:6px;">${time}</div>
              <div class="strong" style="margin-top:6px;">${summary}</div>
            </div>
          </div>
          <div class="miniRow noPrint">
            <button class="miniBtn" data-act="load" data-id="${item.id}">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="miniBtn" data-act="copy" data-id="${item.id}">ë³µì‚¬</button>
            <button class="miniBtn" data-act="del" data-id="${item.id}">ì‚­ì œ</button>
          </div>
        `;
        wrap.appendChild(el);
      });

      wrap.onclick = async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        const list2 = loadHistory();
        const found = list2.find(x => x && x.id === id);
        if (!found) return;

        if (act === "load"){
          fillFormFrom(found);
        } else if (act === "del"){
          deleteOne(id);
        } else if (act === "copy"){
          const text = buildText(found);
          try{
            await navigator.clipboard.writeText(text);
            alert("ë³µì‚¬ ì™„ë£Œ!");
          }catch(e2){
            alert("ìë™ ë³µì‚¬ê°€ ë§‰í˜”ì–´. ë¶ˆëŸ¬ì˜¤ê¸° í›„ ê²°ê³¼ì°½ì„ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì¤˜.");
          }
        }
      };
    }

    function loadRecentOne(){
      const list = loadHistory();
      if (!list.length) return alert("ì €ì¥ëœ ì •ì‚°ì´ ì—†ì–´.");
      fillFormFrom(list[0]);
    }

    function setLocked(on){
      locked = on;
      const inputs = ["memo","kg1","price1","kg2","price2","iceBoxes","iceUnit","fuelQty","fuelUnit","food","divideBy"];
      inputs.forEach(id=>{
        const el = $(id);
        if (el) el.disabled = on;
      });

      $("lockBadge").style.display = on ? "inline-flex" : "none";
      $("lockBtn").style.display = on ? "none" : "block";
      $("unlockBtn").style.display = on ? "block" : "none";

      $("calcBtn").disabled = on;
      $("saveBtn").disabled = on;
      $("pngBtn").disabled = false;
      $("kakaoImgBtn").disabled = false;
    }

    function backupJSON(){
      const list = loadHistory();
      const blob = new Blob([JSON.stringify(list, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `ë‚™ì§€ì •ì‚°_ë°±ì—…_${nowYMD().replaceAll("/","-")}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function restoreJSON(){
      $("restoreFile").click();
    }
    function handleRestoreFile(file){
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(String(reader.result || "[]"));
          if (!Array.isArray(data)) throw new Error("í˜•ì‹ ì˜¤ë¥˜");
          saveHistory(data.slice(0, 50));
          renderHistory();
          updateAllPerShareTotal();
          alert("ë³µì› ì™„ë£Œ!");
        }catch(e){
          alert("ë³µì› ì‹¤íŒ¨: JSON íŒŒì¼ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„.");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    function toggleBig(){
      bigPerShare = !bigPerShare;
      document.body.classList.toggle("bigPerShare", bigPerShare);
      $("toggleBigBtn").innerText = bigPerShare ? "ì›ë˜ í¬ê¸°ë¡œ" : "ê°œì¸ë‹¹ ê¸ˆì•¡ í¬ê²Œ ë³´ê¸°";
    }

    function clampDivide(v){
      if (!Number.isFinite(v)) v = 4.5;
      if (v < 0.5) v = 0.5;
      v = Math.round(v * 2) / 2;
      return v;
    }
    function stepDivide(delta){
      if (locked) return;
      const cur = num($("divideBy").value) || 4.5;
      const next = clampDivide(cur + delta);
      $("divideBy").value = next;
      if (lastCalc) calculate();
    }

    $("calcBtn").addEventListener("click", calculate);
    $("copyBtn").addEventListener("click", copyKakao);
    $("saveBtn").addEventListener("click", saveCurrent);
    $("clearAllBtn").addEventListener("click", clearAll);

    $("pdfBtn").addEventListener("click", savePDF);
    $("xlsxBtn").addEventListener("click", exportXLSX);

    $("pngBtn").addEventListener("click", savePNG);
    $("kakaoImgBtn").addEventListener("click", shareToKakaoAsFile);
    $("imgCopyBtn").addEventListener("click", openLastImage);

    $("backupBtn").addEventListener("click", backupJSON);
    $("restoreBtn").addEventListener("click", restoreJSON);
    $("restoreFile").addEventListener("change", (e)=> handleRestoreFile(e.target.files && e.target.files[0]));

    $("recentBtn").addEventListener("click", loadRecentOne);
    $("toggleBigBtn").addEventListener("click", toggleBig);

    $("lockBtn").addEventListener("click", ()=> setLocked(true));
    $("unlockBtn").addEventListener("click", ()=> setLocked(false));

    $("divDownBtn").addEventListener("click", ()=> stepDivide(-0.5));
    $("divUpBtn").addEventListener("click", ()=> stepDivide(+0.5));
    $("divideBy").addEventListener("change", ()=>{
      if (locked) return;
      $("divideBy").value = clampDivide(num($("divideBy").value) || 4.5);
      if (lastCalc) calculate();
    });

    ["memo","kg1","price1","kg2","price2","iceBoxes","iceUnit","fuelQty","fuelUnit","food","divideBy"].forEach(id=>{
      $(id).addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !locked) calculate(); });
    });

    attachCommaInput($("price1"));
    attachCommaInput($("price2"));
    attachCommaInput($("iceUnit"));
    attachCommaInput($("fuelUnit"));
    attachCommaInput($("food"));

    renderHistory();
    updateAllPerShareTotal();

    $("divideBy").value = 4.5;
  </script>
</body>
</html>
