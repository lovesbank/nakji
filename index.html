<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>낙지잡이</title>
  <style>
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 740px;
      margin: 22px auto;
      padding: 0 14px;
      line-height: 1.6;
    }
    h1{ font-size: 22px; text-align:center; margin: 8px 0 14px; }

    .card{
      background:#f5f5f7;
      border:1px solid #e5e5ea;
      border-radius:14px;
      padding:14px;
      margin-bottom: 12px;
    }
    .titleSm{ font-weight:700; margin-top:8px; }

    label{ display:block; margin-top:10px; font-size:14px; }
    input{
      width:100%;
      padding:10px;
      margin-top:6px;
      border:1px solid #d1d1d6;
      border-radius:12px;
      font-size:16px;
      box-sizing:border-box;
      background:#fff;
    }
    .row{ display:flex; gap:10px; }
    .row > div{ flex:1; }

    button{
      width:100%;
      padding:12px;
      margin-top:12px;
      border:0;
      border-radius:14px;
      font-size:16px;
    }
    .primary{ background:#007aff;color:#fff; }
    .secondary{ background:#111;color:#fff; }
    .ghost{ background:#fff;border:1px solid #d1d1d6; }

    .btnRow{ display:flex; gap:10px; margin-top:12px; }
    .btnRow button{ margin-top:0; width:100%; }

    .result{
      margin-top:14px;
      white-space:pre-line;
      background:#fff;
      border:1px solid #e5e5ea;
      border-radius:14px;
      padding:12px;
      user-select:text;
      -webkit-user-select:text;
    }

    .sectionTitle{
      font-size:15px;
      font-weight:700;
      margin: 2px 0 8px;
    }
    .historyList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .historyItem{
      background:#fff;
      border:1px solid #e5e5ea;
      border-radius:14px;
      padding:12px;
    }
    .historyTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .tag{
      font-size:12px;
      color:#444;
      background:#f2f2f7;
      border:1px solid #e5e5ea;
      padding:4px 8px;
      border-radius:999px;
      display:inline-block;
      max-width: 72%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .miniBtn{
      font-size:13px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid #d1d1d6;
      background:#fff;
      width:auto;
      margin:0;
    }
    .miniRow{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .muted{ color:#777; font-size:12px; }
    .strong{ font-weight:700; }

    .exportRow{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .exportRow button{
      margin-top:0;
      width:100%;
    }
  </style>
</head>

<body>
  <h1>낙지잡이</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>정산 메모(선택)</label>
        <input type="text" id="memo" placeholder="예: 12/30 여수 1차" />
      </div>
    </div>

    <div class="titleSm">낙지 1</div>
    <div class="row">
      <div>
        <label>낙지1 (kg)</label>
        <input type="number" id="kg1" inputmode="decimal" placeholder="예: 12" />
      </div>
      <div>
        <label>단가1 (원)</label>
        <input type="text" id="price1" inputmode="numeric" placeholder="예: 35,000" />
      </div>
    </div>

    <div class="titleSm">낙지 2</div>
    <div class="row">
      <div>
        <label>낙지2 (kg)</label>
        <input type="number" id="kg2" inputmode="decimal" placeholder="예: 8" />
      </div>
      <div>
        <label>단가2 (원)</label>
        <input type="text" id="price2" inputmode="numeric" placeholder="예: 40,000" />
      </div>
    </div>

    <div class="titleSm">경비</div>

    <div class="row">
      <div>
        <label>입감 (박스)</label>
        <input type="number" id="iceBoxes" inputmode="numeric" placeholder="예: 2" />
      </div>
      <div>
        <label>입감 단가 (원)</label>
        <input type="text" id="iceUnit" inputmode="numeric" value="60,000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>기름 수량</label>
        <input type="number" id="fuelQty" inputmode="decimal" placeholder="예: 3" />
      </div>
      <div>
        <label>기름 단가 (원)</label>
        <input type="text" id="fuelUnit" inputmode="numeric" value="200,000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>부식 (원)</label>
        <input type="text" id="food" inputmode="numeric" placeholder="예: 50,000" />
      </div>
      <div>
        <label>개인당 나누기 (기본 4.5)</label>
        <input type="number" id="divideBy" inputmode="decimal" value="4.5" />
      </div>
    </div>

    <button class="primary" id="calcBtn">계산하기</button>

    <div class="btnRow">
      <button class="secondary" id="copyBtn">카톡으로 보내기(복사)</button>
      <button class="ghost" id="saveBtn">이 정산 저장</button>
    </div>

    <div class="exportRow">
      <button class="ghost" id="csvBtn">CSV 저장</button>
      <button class="ghost" id="pdfBtn">PDF 저장</button>
    </div>

    <div class="result" id="result">값 입력 → 계산하기</div>
  </div>

  <div class="card">
    <div class="historyTop">
      <div>
        <div class="sectionTitle">저장된 정산</div>
        <div class="muted">※ 최대 50개까지 저장</div>
      </div>
      <button class="miniBtn" id="clearAllBtn">전체 삭제</button>
    </div>

    <div class="historyList" id="historyList">
      <div class="muted">아직 저장된 정산이 없어.</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const STORAGE_KEY = "nakji_settlements_v8";
    let kakaoText = "";
    let lastCalc = null;

    function num(v){
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    }
    function uncomma(v){
      const s = String(v ?? "").replace(/,/g, "").trim();
      if (!s) return 0;
      const clean = s.replace(/[^\d.-]/g, "");
      return Number(clean) || 0;
    }
    function won(x){
      return Math.round(x).toLocaleString("ko-KR") + "원";
    }
    function nfmtInt(x){
      return Math.round(x).toLocaleString("ko-KR");
    }

    // 원화 입력 콤마 자동(정수)
    function attachCommaInput(el){
      if (!el) return;
      el.addEventListener("input", () => {
        const raw = el.value.replace(/,/g, "").replace(/[^\d]/g, "");
        if (!raw) { el.value = ""; return; }
        el.value = Number(raw).toLocaleString("ko-KR");
      });
      el.addEventListener("blur", () => {
        const raw = el.value.replace(/,/g, "").replace(/[^\d]/g, "");
        if (!raw) { el.value = ""; return; }
        el.value = Number(raw).toLocaleString("ko-KR");
      });
    }

    function nowLabel(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function buildText(calc){
      const {
        memo, createdAt,
        kg1, price1, total1,
        kg2, price2, total2,
        nakjiTotal,

        iceBoxes, iceUnit, iceCost,
        fuelQty, fuelUnit, fuelCost,

        food,
        feeRate, coopFee,

        totalCost,
        finalTotal,
        divideBy, perShare
      } = calc;

      const memoLine = memo ? `메모: ${memo}\n` : "";
      const timeLine = createdAt ? `시간: ${createdAt}\n` : "";

      return `[낙지잡이 정산]
${timeLine}${memoLine}
1) 낙지: ${kg1}kg × ${nfmtInt(price1)}원 = ${won(total1)}
2) 낙지: ${kg2}kg × ${nfmtInt(price2)}원 = ${won(total2)}
낙지 총합: ${won(nakjiTotal)}

[경비]
입감: ${iceBoxes}박스 × ${nfmtInt(iceUnit)}원 = ${won(iceCost)}
기름값: ${fuelQty} × ${nfmtInt(fuelUnit)}원 = ${won(fuelCost)}
수협수수료: 낙지 총합의 5% = ${won(coopFee)}
부식: ${won(food)}
총 경비: ${won(totalCost)}

최종합계: 낙지총합 - 경비(입감+기름값+수협수수료+부식) = ${won(finalTotal)}
개인당: 최종합계 ÷ ${divideBy} = ${won(perShare)}`;
    }

    function calculate(){
      const memo = $("memo").value.trim();

      const kg1 = num($("kg1").value);
      const price1 = uncomma($("price1").value);
      const total1 = kg1 * price1;

      const kg2 = num($("kg2").value);
      const price2 = uncomma($("price2").value);
      const total2 = kg2 * price2;

      const nakjiTotal = total1 + total2;

      const iceBoxes = num($("iceBoxes").value);
      const iceUnit  = uncomma($("iceUnit").value);
      const iceCost  = iceBoxes * iceUnit;

      const fuelQty  = num($("fuelQty").value);
      const fuelUnit = uncomma($("fuelUnit").value);
      const fuelCost = fuelQty * fuelUnit;

      const food = uncomma($("food").value);

      const divideBy = num($("divideBy").value) || 1;

      const feeRate = 0.05;
      const coopFee = nakjiTotal * feeRate;

      const totalCost = iceCost + fuelCost + coopFee + food;
      const finalTotal = nakjiTotal - totalCost;
      const perShare = finalTotal / divideBy;

      const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (String(Date.now()) + "_" + Math.random().toString(16).slice(2));

      lastCalc = {
        id,
        createdAt: nowLabel(),
        memo,

        kg1, price1, total1,
        kg2, price2, total2,
        nakjiTotal,

        iceBoxes, iceUnit, iceCost,
        fuelQty, fuelUnit, fuelCost,

        food,
        feeRate, coopFee,

        totalCost,
        finalTotal,
        divideBy, perShare
      };

      kakaoText = buildText(lastCalc);
      $("result").innerText = kakaoText;
    }

    async function copyKakao(){
      if (!kakaoText) calculate();
      if (!kakaoText){
        alert("값을 입력하고 계산해줘.");
        return;
      }
      try{
        await navigator.clipboard.writeText(kakaoText);
        alert("복사 완료! 카톡에서 붙여넣기만 하면 돼.");
      }catch(e){
        alert("자동 복사가 막혔어. 아래 정산문을 길게 눌러서 전체 선택 후 복사해줘.");
      }
    }

    function loadHistory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }
    function saveHistory(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function saveCurrent(){
      if (!lastCalc) calculate();
      if (!lastCalc){
        alert("값을 입력하고 계산한 뒤 저장해줘.");
        return;
      }
      const list = loadHistory();
      list.unshift(lastCalc);
      saveHistory(list.slice(0, 50));
      renderHistory();
      alert("저장 완료!");
    }

    function deleteOne(id){
      const list = loadHistory().filter(x => x && x.id !== id);
      saveHistory(list);
      renderHistory();
    }

    function clearAll(){
      const ok = confirm("저장된 정산을 전부 삭제할까?");
      if (!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
    }

    function fillFormFrom(calc){
      $("memo").value = calc.memo || "";

      $("kg1").value = (calc.kg1 ?? "");
      $("price1").value = nfmtInt(calc.price1 ?? 0);

      $("kg2").value = (calc.kg2 ?? "");
      $("price2").value = nfmtInt(calc.price2 ?? 0);

      $("iceBoxes").value = (calc.iceBoxes ?? "");
      $("iceUnit").value = nfmtInt(calc.iceUnit ?? 0);

      $("fuelQty").value = (calc.fuelQty ?? "");
      $("fuelUnit").value = nfmtInt(calc.fuelUnit ?? 0);

      $("food").value = nfmtInt(calc.food ?? 0);
      $("divideBy").value = (calc.divideBy ?? 4.5);

      lastCalc = calc;
      kakaoText = buildText(calc);
      $("result").innerText = kakaoText;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function renderHistory(){
      const list = loadHistory();
      const wrap = $("historyList");

      if (!list.length){
        wrap.innerHTML = `<div class="muted">아직 저장된 정산이 없어.</div>`;
        return;
      }

      wrap.innerHTML = "";
      list.forEach((item) => {
        const title = item.memo ? item.memo : "정산";
        const time = item.createdAt ? item.createdAt : "";
        const summary = `낙지총합 ${won(item.nakjiTotal)} / 최종 ${won(item.finalTotal)} / 개인당(÷${item.divideBy}) ${won(item.perShare)}`;

        const el = document.createElement("div");
        el.className = "historyItem";
        el.innerHTML = `
          <div class="historyTop">
            <div>
              <div class="tag">${title}</div>
              <div class="muted" style="margin-top:6px;">${time}</div>
              <div class="strong" style="margin-top:6px;">${summary}</div>
            </div>
          </div>
          <div class="miniRow">
            <button class="miniBtn" data-act="load" data-id="${item.id}">불러오기</button>
            <button class="miniBtn" data-act="copy" data-id="${item.id}">복사</button>
            <button class="miniBtn" data-act="del" data-id="${item.id}">삭제</button>
          </div>
        `;
        wrap.appendChild(el);
      });

      wrap.onclick = async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        const list2 = loadHistory();
        const found = list2.find(x => x && x.id === id);
        if (!found) return;

        if (act === "load"){
          fillFormFrom(found);
        } else if (act === "del"){
          deleteOne(id);
        } else if (act === "copy"){
          const text = buildText(found);
          try{
            await navigator.clipboard.writeText(text);
            alert("복사 완료! 카톡에 붙여넣기만 하면 돼.");
          }catch(e2){
            alert("자동 복사가 막혔어. 불러오기 후 결과창을 길게 눌러 복사해줘.");
          }
        }
      };
    }

    /* ===========================
       파일명 예쁘게 + CSV/PDF 저장
       =========================== */

    function compactDateLabel(isoLike){
      const s = String(isoLike || "").trim();
      if (!s) return "";
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})/);
      if (!m) return s.replace(/[^\d]/g,"").slice(0,12);
      return `${m[1]}${m[2]}${m[3]}_${m[4]}${m[5]}`;
    }

    function sanitizeFilePart(s){
      return String(s ?? "")
        .trim()
        .replace(/\s+/g, "_")
        .replace(/[\\/:*?"<>|]/g, "_")
        .replace(/_+/g, "_")
        .slice(0, 24);
    }

    function toMoneyShort(x){
      const n = Math.round(Number(x) || 0);
      const abs = Math.abs(n);
      if (abs >= 100000000) return (n/100000000).toFixed(1).replace(/\.0$/,"") + "억";
      if (abs >= 10000) return (n/10000).toFixed(1).replace(/\.0$/,"") + "만";
      return String(n);
    }

    function buildNiceFileName(calc, ext){
      const x = calc || {};
      const dt = compactDateLabel(x.createdAt) || compactDateLabel(nowLabel());
      const memo = sanitizeFilePart(x.memo || "정산");
      const finalS = toMoneyShort(x.finalTotal);
      const perS   = toMoneyShort(x.perShare);
      const divS   = (x.divideBy != null) ? String(x.divideBy).replace(/\.0$/,"") : "";

      const base = [
        "낙지정산",
        dt,
        memo,
        `최종${finalS}`,
        `개인당${perS}`,
        divS ? `나눔${divS}` : ""
      ].filter(Boolean).join("_");

      return `${base}.${ext}`;
    }

    function csvEscape(s){
      const str = String(s ?? "");
      if (/[",\n]/.test(str)) return `"${str.replace(/"/g,'""')}"`;
      return str;
    }

    function exportCSV(calc){
      if (!lastCalc) calculate();
      const x = calc || lastCalc;
      if (!x){ alert("먼저 계산해줘."); return; }

      const rows = [];
      rows.push([
        "시간","메모",
        "낙지1kg","단가1","낙지1합계",
        "낙지2kg","단가2","낙지2합계",
        "낙지총합",
        "입감박스","입감단가","입감비",
        "기름수량","기름단가","기름비",
        "수협수수료(5%)",
        "부식",
        "총경비",
        "최종합계",
        "개인당나누기",
        "개인당"
      ]);

      rows.push([
        x.createdAt, x.memo,
        x.kg1, x.price1, Math.round(x.total1),
        x.kg2, x.price2, Math.round(x.total2),
        Math.round(x.nakjiTotal),
        x.iceBoxes, x.iceUnit, Math.round(x.iceCost),
        x.fuelQty, x.fuelUnit, Math.round(x.fuelCost),
        Math.round(x.coopFee),
        x.food,
        Math.round(x.totalCost),
        Math.round(x.finalTotal),
        x.divideBy,
        Math.round(x.perShare)
      ]);

      const csv = rows.map(r => r.map(csvEscape).join(",")).join("\n");
      const bom = "\uFEFF"; // 한글 엑셀 호환
      const blob = new Blob([bom + csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = buildNiceFileName(x, "csv");
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportPDF(calc){
      if (!lastCalc) calculate();
      const x = calc || lastCalc;
      if (!x){ alert("먼저 계산해줘."); return; }

      const text = buildText(x);
      const fileName = buildNiceFileName(x, "pdf");

      const w = window.open("", "_blank", "noopener,noreferrer");
      if (!w){
        alert("팝업이 막혔어. 브라우저에서 팝업 허용 후 다시 눌러줘.");
        return;
      }

      const safeHTML = text
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/\n/g,"<br>");

      const html = `
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>${fileName}</title>
<style>
  body{ margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .wrap{ padding:18px; line-height:1.55; font-size:14px; }
  .title{ font-weight:800; font-size:16px; margin-bottom:10px; }
  .fname{ font-size:12px; color:#666; margin-bottom:12px; }
  .box{ white-space:pre-line; }
  @media print{
    .noPrint{ display:none; }
    .wrap{ padding:0; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">낙지잡이 정산</div>
    <div class="fname">추천 파일명: <b>${fileName}</b></div>
    <div class="box">${safeHTML}</div>
    <div class="noPrint" style="margin-top:14px; color:#666; font-size:12px;">
      인쇄 → “PDF로 저장” 누르고, 파일명은 위 추천 파일명으로 저장하면 깔끔해.
    </div>
  </div>
  <script>
    window.onload = () => { window.print(); };
  <\/script>
</body>
</html>`;
      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    // 이벤트
    $("calcBtn").addEventListener("click", calculate);
    $("copyBtn").addEventListener("click", copyKakao);
    $("saveBtn").addEventListener("click", saveCurrent);
    $("clearAllBtn").addEventListener("click", clearAll);
    $("csvBtn").addEventListener("click", () => exportCSV());
    $("pdfBtn").addEventListener("click", () => exportPDF());

    // Enter로 계산
    ["memo","kg1","price1","kg2","price2","iceBoxes","iceUnit","fuelQty","fuelUnit","food","divideBy"].forEach(id=>{
      $(id).addEventListener("keydown", (e)=>{ if(e.key==="Enter") calculate(); });
    });

    // 콤마 자동 적용(원화 입력)
    attachCommaInput($("price1"));
    attachCommaInput($("price2"));
    attachCommaInput($("iceUnit"));
    attachCommaInput($("fuelUnit"));
    attachCommaInput($("food"));

    // 첫 로드
    renderHistory();
  </script>
</body>
</html>
