<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë‚™ì§€ì¡ì´</title>

  <!-- PWA(í™ˆí™”ë©´ ì¶”ê°€) ê¸°ë³¸ -->
  <meta name="theme-color" content="#0a84ff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <style>
    :root{
      --bg:#f2f2f7;
      --text:#111;
      --card:#f5f5f7;
      --card2:#fff;
      --line:#e5e5ea;
      --muted:#666;
      --muted2:#777;
      --primary:#007aff;
      --secondary:#111;
      --ghostBg:#fff;
      --ghostLine:#d1d1d6;
      --tagBg:#f2f2f7;
      --tagLine:#e5e5ea;
      --danger:#ff3b30;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#000;
        --text:#f5f5f7;
        --card:#101012;
        --card2:#16161a;
        --line:#2c2c2e;
        --muted:#a1a1a6;
        --muted2:#8e8e93;
        --primary:#0a84ff;
        --secondary:#f5f5f7;
        --ghostBg:#1c1c1e;
        --ghostLine:#3a3a3c;
        --tagBg:#1c1c1e;
        --tagLine:#3a3a3c;
        --danger:#ff453a;
      }
    }

    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 740px;
      margin: 22px auto;
      padding: 0 14px;
      line-height: 1.6;
      background: var(--bg);
      color: var(--text);
    }
    h1{ font-size: 22px; text-align:center; margin: 8px 0 14px; }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom: 12px;
    }

    .titleSm{ font-weight:700; margin-top:8px; }
    .sectionTitle{ font-size:15px; font-weight:700; margin: 2px 0 8px; }

    label{ display:block; margin-top:10px; font-size:14px; color:var(--text); }
    input{
      width:100%;
      padding:10px;
      margin-top:6px;
      border:1px solid var(--ghostLine);
      border-radius:12px;
      font-size:16px;
      background: var(--ghostBg);
      color: var(--text);
      outline:none;
    }

    .row{ display:flex; gap:10px; }
    .row > div{ flex:1; }

    button{
      width:100%;
      padding:12px;
      margin-top:12px;
      border:0;
      border-radius:14px;
      font-size:16px;
      background: var(--ghostBg);
      color: var(--text);
    }
    button:disabled{ opacity:0.6; }

    .primary{ background: var(--primary); color:#fff; }
    .secondary{ background: var(--secondary); color:#fff; }
    @media (prefers-color-scheme: dark){
      .secondary{ background: #f5f5f7; color:#000; }
    }
    .ghost{ background: var(--ghostBg); border:1px solid var(--ghostLine); }

    .btnRow{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .btnRow button{ margin-top:0; width:100%; }
    .btnRow.three button{ width: calc(33.333% - 6.66px); }
    .btnRow.two button{ width: calc(50% - 5px); }

    .result{
      margin-top:14px;
      white-space:pre-line;
      background: var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      user-select:text;
      -webkit-user-select:text;
    }

    .muted{ color:var(--muted2); font-size:12px; }
    .strong{ font-weight:700; }

    .historyList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .historyItem{
      background: var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .historyTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .tag{
      font-size:12px;
      color:var(--text);
      background: var(--tagBg);
      border:1px solid var(--tagLine);
      padding:4px 8px;
      border-radius:999px;
      display:inline-block;
      max-width: 72%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .miniBtn{
      font-size:13px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--ghostLine);
      background: var(--ghostBg);
      width:auto;
      margin:0;
    }
    .miniRow{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:10px;
      flex-wrap:wrap;
    }

    .perShareLine{
      font-size:22px;
      font-weight:900;
      line-height:1.3;
      padding-top:6px;
    }

    .stepper{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:6px;
    }
    .stepBtn{
      width:44px;
      min-width:44px;
      padding:10px 0;
      margin:0;
      border-radius:12px;
      border:1px solid var(--ghostLine);
      background: var(--ghostBg);
      font-size:18px;
      line-height:1;
    }
    .stepper input{
      margin-top:0;
      text-align:center;
      font-weight:700;
    }

    .topTotalLine{
      background: var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }

    /* âœ… ìƒë‹¨ ì´í•©(í¸ì§‘ ê°€ëŠ¥) ì „ìš© */
    .topTotalsGrid{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .topTotalsRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .topTotalsLabel{
      font-weight:900;
      font-size:18px;
      line-height:1.2;
      white-space:nowrap;
    }
    .topTotalsInput{
      width: 52%;
      margin:0;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--ghostLine);
      background: var(--ghostBg);
      color: var(--text);
      font-weight:900;
      font-size:20px;
      text-align:right;
    }
    .topTotalsValue{
      font-weight:900;
      font-size:22px;
      text-align:right;
      white-space:nowrap;
      color: var(--danger);
    }
    .refreshBtn{
      width:auto;
      margin-top:0;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--ghostLine);
      background: var(--ghostBg);
      font-size:14px;
      font-weight:800;
      white-space:nowrap;
    }
    .topMetaLine{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }

    @media print{
      body{ max-width:none; margin:0; padding:0; }
      .noPrint{ display:none !important; }
      .card{ border:none; background:transparent; }
      .result{ border:1px solid #999; }
    }
  </style>
</head>

<body>
  <h1>ë‚™ì§€ì¡ì´</h1>

  <!-- âœ… ìƒë‹¨ ì´í•© ì¹´ë“œ (ìˆ«ì í¸ì§‘ ê°€ëŠ¥ + ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ + ë˜ëŒë¦¬ê¸°) -->
  <div class="card">
    <div class="topTotalLine">
      <div class="topTotalsGrid">
        <div class="topTotalsRow">
          <div class="topTotalsLabel">ì´ì „ ì´í•© (í™•ì •)</div>
          <input class="topTotalsInput" id="prevTotal" type="text" inputmode="numeric" value="0" />
        </div>

        <div class="topTotalsRow">
          <div class="topTotalsLabel">ì´ë²ˆ ì´í•©</div>
          <input class="topTotalsInput" id="currTotal" type="text" inputmode="numeric" value="0" />
        </div>

        <div class="topTotalsRow">
          <div class="topTotalsLabel">ëˆ„ì  ì´í•©</div>
          <div class="topTotalsValue" id="sumAllPer">0ì›</div>
        </div>
      </div>

      <div class="topMetaLine noPrint">
        <div class="muted" id="calcTime"></div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="refreshBtn" id="restoreTotalsBtn" type="button">â†© ì´ì „ê°’ ë˜ëŒë¦¬ê¸°</button>
          <button class="refreshBtn" id="refreshTotalsBtn" type="button">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì…ë ¥ ì¹´ë“œ -->
  <div class="card" id="inputCard">
    <div class="row">
      <div>
        <label>ì •ì‚° ë©”ëª¨(ì„ íƒ)</label>
        <input type="text" id="memo" placeholder="ì˜ˆ: 12/30 ì—¬ìˆ˜ 1ì°¨" />
      </div>
    </div>

    <div class="titleSm">ë‚™ì§€ 1</div>
    <div class="row">
      <div>
        <label>ë‚™ì§€1 (kg)</label>
        <input type="number" id="kg1" inputmode="decimal" placeholder="ì˜ˆ: 12" />
      </div>
      <div>
        <label>ë‹¨ê°€1 (ì›)</label>
        <input type="text" id="price1" inputmode="numeric" placeholder="ì˜ˆ: 35,000" />
      </div>
    </div>

    <div class="titleSm">ë‚™ì§€ 2</div>
    <div class="row">
      <div>
        <label>ë‚™ì§€2 (kg)</label>
        <input type="number" id="kg2" inputmode="decimal" placeholder="ì˜ˆ: 8" />
      </div>
      <div>
        <label>ë‹¨ê°€2 (ì›)</label>
        <input type="text" id="price2" inputmode="numeric" placeholder="ì˜ˆ: 40,000" />
      </div>
    </div>

    <div class="titleSm">ê²½ë¹„</div>

    <div class="row">
      <div>
        <label>ì…ê° (ë°•ìŠ¤)</label>
        <input type="number" id="iceBoxes" inputmode="numeric" placeholder="ì˜ˆ: 2" />
      </div>
      <div>
        <label>ì…ê° ë‹¨ê°€ (ì›)</label>
        <input type="text" id="iceUnit" inputmode="numeric" value="60,000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>ê¸°ë¦„ ìˆ˜ëŸ‰</label>
        <input type="number" id="fuelQty" inputmode="decimal" placeholder="ì˜ˆ: 3" />
      </div>
      <div>
        <label>ê¸°ë¦„ ë‹¨ê°€ (ì›)</label>
        <input type="text" id="fuelUnit" inputmode="numeric" value="200,000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>ë¶€ì‹ (ì›)</label>
        <input type="text" id="food" inputmode="numeric" placeholder="ì˜ˆ: 50,000" />
      </div>
      <div>
        <label>ê°œì¸ë‹¹ ë‚˜ëˆ„ê¸°</label>
        <div class="stepper noPrint">
          <button class="stepBtn" id="divDownBtn" type="button">âˆ’</button>
          <input type="number" id="divideBy" inputmode="decimal" step="0.5" value="4.5" />
          <button class="stepBtn" id="divUpBtn" type="button">+</button>
        </div>
      </div>
    </div>

    <button class="primary noPrint" id="calcBtn">ê³„ì‚°í•˜ê¸°</button>

    <div class="btnRow three noPrint">
      <button class="secondary" id="copyBtn">ì¹´í†¡ìœ¼ë¡œ ë³´ë‚´ê¸°(ë³µì‚¬)</button>
      <button class="ghost" id="saveBtn">ì´ ì •ì‚° ì €ì¥</button>
      <button class="ghost" id="pngBtn">ì´ë¯¸ì§€ ì €ì¥(PNG)</button>
    </div>

    <div class="btnRow two noPrint">
      <button class="ghost" id="kakaoImgBtn">ì¹´í†¡ìœ¼ë¡œ ì´ë¯¸ì§€ ë³´ë‚´ê¸°</button>
      <button class="ghost" id="pdfBtn">PDF ì €ì¥(ì¸ì‡„)</button>
    </div>

    <div class="result" id="result">ê°’ ì…ë ¥ â†’ ê³„ì‚°í•˜ê¸°</div>
  </div>

  <!-- ì €ì¥ íˆìŠ¤í† ë¦¬ -->
  <div class="card">
    <div class="historyTop noPrint">
      <div>
        <div class="sectionTitle">ì €ì¥ëœ ì •ì‚°</div>
        <div class="muted">â€» ìµœëŒ€ 50ê°œê¹Œì§€ ì €ì¥</div>
      </div>
      <button class="miniBtn" id="clearAllBtn">ì „ì²´ ì‚­ì œ</button>
    </div>

    <div class="historyList" id="historyList">
      <div class="muted">ì•„ì§ ì €ì¥ëœ ì •ì‚°ì´ ì—†ì–´.</div>
    </div>
  </div>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬: PNG ìº¡ì²˜ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    const STORAGE_KEY = "nakji_settlements_final_split_v1";

    /* âœ… ìƒë‹¨ ì´í•©(í¸ì§‘/í™•ì •/ì´ˆê¸°í™”) ì €ì¥ í‚¤ */
    const TOTALS_KEY = "nakji_totals_v1"; // { prev:number, curr:number }

    /* âœ… ë˜ëŒë¦¬ê¸°(1ë‹¨ê³„) ë°±ì—… í‚¤ */
    const TOTALS_BACKUP_KEY = "nakji_totals_backup_v1"; // { prev:number, curr:number }

    let kakaoText = "";
    let lastCalc = null;

    let locked = false;
    let lastImageDataUrl = "";

    function num(v){
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    }
    function uncomma(v){
      const s = String(v ?? "").replace(/,/g, "").trim();
      if (!s) return 0;
      const clean = s.replace(/[^\d.-]/g, "");
      return Number(clean) || 0;
    }
    function won(x){
      return Math.round(x).toLocaleString("ko-KR") + "ì›";
    }
    function nfmtInt(x){
      return Math.round(x).toLocaleString("ko-KR");
    }

    function attachCommaInput(el){
      if (!el) return;
      el.addEventListener("input", () => {
        if (locked) return;
        const raw = el.value.replace(/,/g, "").replace(/[^\d]/g, "");
        if (!raw) { el.value = ""; return; }
        el.value = Number(raw).toLocaleString("ko-KR");
      });
      el.addEventListener("blur", () => {
        if (locked) return;
        const raw = el.value.replace(/,/g, "").replace(/[^\d]/g, "");
        if (!raw) { el.value = ""; return; }
        el.value = Number(raw).toLocaleString("ko-KR");
      });
    }

    function nowLabel(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }
    function nowYMD(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}/${mm}/${dd}`;
    }

    function extractDateKey(item){
      const memo = String(item?.memo || "");
      let m = memo.match(/(\d{4})[\/-](\d{2})[\/-](\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;

      const createdAt = String(item?.createdAt || "");
      m = createdAt.match(/(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;

      return "ê¸°íƒ€";
    }

    function loadHistory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }
    function saveHistory(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    /* âœ… ìƒë‹¨ ì´í•© ë¡œì§ (í¸ì§‘ ê°€ëŠ¥) */
    function loadTotals(){
      try{
        const raw = localStorage.getItem(TOTALS_KEY);
        const obj = raw ? JSON.parse(raw) : null;
        const prev = Number(obj?.prev ?? 0) || 0;
        const curr = Number(obj?.curr ?? 0) || 0;
        return { prev, curr };
      }catch(e){
        return { prev:0, curr:0 };
      }
    }
    function saveTotals(prev, curr){
      localStorage.setItem(TOTALS_KEY, JSON.stringify({
        prev: Number(prev)||0,
        curr: Number(curr)||0
      }));
    }
    function setTotalsUI(prev, curr){
      $("prevTotal").value = nfmtInt(prev);
      $("currTotal").value = nfmtInt(curr);
      $("sumAllPer").innerText = won((Number(prev)||0) + (Number(curr)||0));
    }
    function syncTotalsFromInputs(){
      const prev = uncomma($("prevTotal").value);
      const curr = uncomma($("currTotal").value);
      saveTotals(prev, curr);
      setTotalsUI(prev, curr);
    }
    function addToCurrTotal(delta){
      const t = loadTotals();
      const nextCurr = (t.curr || 0) + (Number(delta)||0);
      saveTotals(t.prev||0, nextCurr);
      setTotalsUI(t.prev||0, nextCurr);
    }

    /* âœ… (ì¶”ê°€) ë˜ëŒë¦¬ê¸°: ì§ì „ ì´í•© ìƒíƒœë¡œ ë³µì› */
    function restorePreviousTotals(){
      const raw = localStorage.getItem(TOTALS_BACKUP_KEY);
      if (!raw){
        alert("ë˜ëŒë¦´ ì´ì „ ê°’ì´ ì—†ì–´.");
        return;
      }

      const ok = confirm("ì´ì „ ê°œì¸ë‹¹ ì´í•©ìœ¼ë¡œ ë˜ëŒë¦´ê¹Œìš”?");
      if (!ok) return;

      try{
        const b = JSON.parse(raw);
        const prev = Number(b?.prev ?? 0) || 0;
        const curr = Number(b?.curr ?? 0) || 0;

        saveTotals(prev, curr);
        setTotalsUI(prev, curr);

        alert("ì´ì „ ê°’ìœ¼ë¡œ ë˜ëŒë ¸ì–´.");
      }catch(e){
        alert("ë˜ëŒë¦¬ê¸°ì— ì‹¤íŒ¨í–ˆì–´.");
      }
    }

    function ensureMemoDefault(){
      const m = $("memo").value.trim();
      if (!m) $("memo").value = `${nowYMD()} ì •ì‚°`;
    }

    function buildText(calc){
      const memoLine = calc.memo ? `ë©”ëª¨: ${calc.memo}\n` : "";
      const timeLine = calc.createdAt ? `ì‹œê°„: ${calc.createdAt}\n` : "";
      const perLine = `ê°œì¸ë‹¹: ìµœì¢…í•©ê³„ Ã· ${calc.divideBy} = ${won(calc.perShareRounded)}`;

      return `[ë‚™ì§€ì¡ì´ ì •ì‚°]
${timeLine}${memoLine}
1) ë‚™ì§€: ${calc.kg1}kg Ã— ${nfmtInt(calc.price1)}ì› = ${won(calc.total1)}
2) ë‚™ì§€: ${calc.kg2}kg Ã— ${nfmtInt(calc.price2)}ì› = ${won(calc.total2)}
ë‚™ì§€ ì´í•©: ${won(calc.nakjiTotal)}

[ê²½ë¹„]
ì…ê°: ${calc.iceBoxes}ë°•ìŠ¤ Ã— ${nfmtInt(calc.iceUnit)}ì› = ${won(calc.iceCost)}
ê¸°ë¦„ê°’: ${calc.fuelQty} Ã— ${nfmtInt(calc.fuelUnit)}ì› = ${won(calc.fuelCost)}
ìˆ˜í˜‘ìˆ˜ìˆ˜ë£Œ: ë‚™ì§€ ì´í•©ì˜ 5% = ${won(calc.coopFee)}
ë¶€ì‹: ${won(calc.food)}
ì´ ê²½ë¹„: ${won(calc.totalCost)}

ìµœì¢…í•©ê³„: ${won(calc.finalTotal)}
${perLine}`;
    }

    function renderResult(calc){
      kakaoText = buildText(calc);

      const perLine = `ê°œì¸ë‹¹: ìµœì¢…í•©ê³„ Ã· ${calc.divideBy} = ${won(calc.perShareRounded)}`;
      $("result").innerHTML = "";

      const pre = document.createElement("div");
      pre.style.whiteSpace = "pre-line";
      pre.textContent = kakaoText.replace(perLine, "").trimEnd() + "\n";
      $("result").appendChild(pre);

      const perDiv = document.createElement("div");
      perDiv.className = "perShareLine";
      perDiv.textContent = perLine;
      $("result").appendChild(perDiv);
    }

    function calculate(){
      ensureMemoDefault();
      const memo = $("memo").value.trim();

      const kg1 = num($("kg1").value);
      const price1 = uncomma($("price1").value);
      const total1 = kg1 * price1;

      const kg2 = num($("kg2").value);
      const price2 = uncomma($("price2").value);
      const total2 = kg2 * price2;

      const nakjiTotal = total1 + total2;

      const iceBoxes = num($("iceBoxes").value);
      const iceUnit  = uncomma($("iceUnit").value) || 0;
      const iceCost  = iceBoxes * iceUnit;

      const fuelQty  = num($("fuelQty").value);
      const fuelUnit = uncomma($("fuelUnit").value) || 0;
      const fuelCost = fuelQty * fuelUnit;

      const food = uncomma($("food").value);
      const divideBy = num($("divideBy").value) || 1;

      const feeRate = 0.05;
      const coopFee = nakjiTotal * feeRate;

      const totalCost = iceCost + fuelCost + coopFee + food;
      const finalTotal = nakjiTotal - totalCost;
      const perShare = finalTotal / divideBy;

      const perShareRounded = perShare;

      const id = (crypto && crypto.randomUUID)
        ? crypto.randomUUID()
        : (String(Date.now()) + "_" + Math.random().toString(16).slice(2));

      lastCalc = {
        id,
        createdAt: nowLabel(),
        memo,
        kg1, price1, total1,
        kg2, price2, total2,
        nakjiTotal,
        iceBoxes, iceUnit, iceCost,
        fuelQty, fuelUnit, fuelCost,
        food,
        feeRate, coopFee,
        totalCost,
        finalTotal,
        divideBy,
        perShare,
        perShareRounded
      };

      $("calcTime").innerText = lastCalc.createdAt ? `ê³„ì‚° ì‹œê°: ${lastCalc.createdAt.split(" ")[1]}` : "";
      renderResult(lastCalc);
      renderHistory();
    }

    async function copyKakao(){
      if (!lastCalc) calculate();
      if (!lastCalc) return;

      try{
        await navigator.clipboard.writeText(kakaoText);
        alert("ë³µì‚¬ ì™„ë£Œ!");
      }catch(e){
        alert("ìë™ ë³µì‚¬ê°€ ë§‰í˜”ì–´. ê²°ê³¼ì°½ì„ ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ë³µì‚¬í•´ì¤˜.");
      }
    }

    function savePDF(){
      if (!lastCalc) calculate();
      window.print();
    }

    function makeCaptureTarget(){
      const target = document.createElement("div");
      target.style.padding = "14px";
      target.style.background = getComputedStyle(document.body).backgroundColor;

      const topClone = document.querySelector(".card").cloneNode(true);
      const inputClone = $("inputCard").cloneNode(true);

      topClone.querySelectorAll(".noPrint").forEach(el=>el.remove());
      inputClone.querySelectorAll(".noPrint").forEach(el=>el.remove());

      target.appendChild(topClone);
      target.appendChild(inputClone);

      target.style.position = "fixed";
      target.style.left = "-99999px";
      target.style.top = "0";
      document.body.appendChild(target);
      return target;
    }

    async function buildCanvas(){
      if (!lastCalc) calculate();
      if (!lastCalc) return null;

      const target = makeCaptureTarget();
      try{
        const canvas = await html2canvas(target, {
          scale: 2,
          backgroundColor: getComputedStyle(document.body).backgroundColor,
          useCORS: true
        });
        return canvas;
      } finally {
        target.remove();
      }
    }

    function safeFilename(){
      const nameSafe = (lastCalc?.memo || "ì •ì‚°")
        .replace(/[\\/:*?"<>|]/g, "_")
        .slice(0, 30);
      return `ë‚™ì§€ì •ì‚°_${nameSafe}.png`;
    }

    async function savePNG(){
      const canvas = await buildCanvas();
      if (!canvas) return;

      const filename = safeFilename();
      lastImageDataUrl = canvas.toDataURL("image/png");

      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      if (isIOS){
        const w = window.open();
        if (w){
          w.document.write(`<img src="${lastImageDataUrl}" style="max-width:100%;height:auto;">`);
          w.document.title = filename;
        } else {
          window.location.href = lastImageDataUrl;
        }
        return;
      }

      const a = document.createElement("a");
      a.href = lastImageDataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function shareToKakaoAsFile(){
      const canvas = await buildCanvas();
      if (!canvas) return;

      const filename = safeFilename();

      if (navigator.share && canvas.toBlob){
        const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
        if (blob){
          const file = new File([blob], filename, { type:"image/png" });

          if (!navigator.canShare || navigator.canShare({ files:[file] })){
            try{
              await navigator.share({
                title: "ë‚™ì§€ì¡ì´ ì •ì‚°",
                text: "ì •ì‚° ì´ë¯¸ì§€ íŒŒì¼",
                files: [file]
              });
              return;
            }catch(e){}
          }
        }
      }

      const dataUrl = canvas.toDataURL("image/png");
      lastImageDataUrl = dataUrl;
      const w = window.open();
      if (w){
        w.document.write(`<img src="${dataUrl}" style="max-width:100%;height:auto;">`);
        w.document.title = filename;
      } else {
        window.location.href = dataUrl;
      }
      alert("ê¸°ê¸°/ë¸Œë¼ìš°ì € ì œí•œìœ¼ë¡œ íŒŒì¼ ê³µìœ ê°€ ì•ˆ ë¼ì„œ, ì´ë¯¸ì§€ íƒ­ì„ ì—´ì—ˆì–´. ê³µìœ ì—ì„œ ì¹´í†¡ì„ ì„ íƒí•´ì¤˜(ë§í¬ë¡œ ê°ˆ ìˆ˜ë„ ìˆì–´).");
    }

    function saveCurrent(){
      if (!lastCalc) calculate();
      if (!lastCalc) return;

      const list = loadHistory();
      list.unshift(lastCalc);
      saveHistory(list.slice(0, 50));
      renderHistory();

      /* âœ… ì €ì¥í•˜ë©´ â€œì´ë²ˆ ì´í•©â€ì— ê°œì¸ë‹¹ ê¸ˆì•¡ì„ ìë™ ëˆ„ì  */
      addToCurrTotal(Number(lastCalc.perShareRounded) || 0);

      alert("ì €ì¥ ì™„ë£Œ!");
    }

    function deleteOne(id){
      const list = loadHistory().filter(x => x && x.id !== id);
      saveHistory(list);
      renderHistory();
    }

    function clearAll(){
      const ok = confirm("ì €ì¥ëœ ì •ì‚°ì„ ì „ë¶€ ì‚­ì œí• ê¹Œ?");
      if (!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
    }

    // âœ… í•µì‹¬: ë¶ˆëŸ¬ì˜¤ê¸°(í¼ ì±„ìš°ê¸° + ê²°ê³¼ë¥¼ 2ë²ˆì‚¬ì§„ì²˜ëŸ¼ ì¦‰ì‹œ í‘œì‹œ)
    function fillFormFrom(calc){
      $("memo").value = calc.memo || "";
      $("kg1").value = (calc.kg1 ?? "");
      $("price1").value = nfmtInt(calc.price1 ?? 0);

      $("kg2").value = (calc.kg2 ?? "");
      $("price2").value = nfmtInt(calc.price2 ?? 0);

      $("iceBoxes").value = (calc.iceBoxes ?? "");
      $("iceUnit").value = nfmtInt(calc.iceUnit ?? 0);

      $("fuelQty").value = (calc.fuelQty ?? "");
      $("fuelUnit").value = nfmtInt(calc.fuelUnit ?? 0);

      $("food").value = nfmtInt(calc.food ?? 0);
      $("divideBy").value = (calc.divideBy ?? 4.5);

      // ì €ì¥ëœ ë°ì´í„°ê°€ ëˆ„ë½ëœ ì¼€ì´ìŠ¤ê¹Œì§€ ì•ˆì „í•˜ê²Œ ë³´ì •
      const nakjiTotal = (calc.nakjiTotal ?? ((calc.total1 ?? 0) + (calc.total2 ?? 0)));
      const coopFee = (calc.coopFee ?? (nakjiTotal * 0.05));
      const iceCost = (calc.iceCost ?? ((calc.iceBoxes ?? 0) * (calc.iceUnit ?? 0)));
      const fuelCost = (calc.fuelCost ?? ((calc.fuelQty ?? 0) * (calc.fuelUnit ?? 0)));
      const totalCost = (calc.totalCost ?? (iceCost + fuelCost + coopFee + (calc.food ?? 0)));
      const finalTotal = (calc.finalTotal ?? (nakjiTotal - totalCost));
      const perShare = (calc.perShareRounded ?? calc.perShare ?? (finalTotal / (calc.divideBy ?? 1)));

      lastCalc = {
        ...calc,
        nakjiTotal,
        coopFee,
        iceCost,
        fuelCost,
        totalCost,
        finalTotal,
        perShareRounded: perShare
      };

      $("calcTime").innerText = lastCalc.createdAt ? `ê³„ì‚° ì‹œê°: ${String(lastCalc.createdAt).split(" ")[1] || ""}` : "";
      renderResult(lastCalc);

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function renderHistory(){
      const list = loadHistory();
      const wrap = $("historyList");

      if (!list.length){
        wrap.innerHTML = `<div class="muted">ì•„ì§ ì €ì¥ëœ ì •ì‚°ì´ ì—†ì–´.</div>`;
        return;
      }

      wrap.innerHTML = "";
      list.forEach((item) => {
        const title = item.memo ? item.memo : "ì •ì‚°";
        const time = item.createdAt ? item.createdAt : "";
        const per = (item.perShareRounded ?? item.perShare ?? 0);
        const summary = `ë‚™ì§€ì´í•© ${won(item.nakjiTotal ?? 0)} / ìµœì¢… ${won(item.finalTotal ?? 0)} / ê°œì¸ë‹¹ ${won(per)}`;

        const el = document.createElement("div");
        el.className = "historyItem";
        el.innerHTML = `
          <div class="historyTop">
            <div>
              <div class="tag">${title}</div>
              <div class="muted" style="margin-top:6px;">${time}</div>
              <div class="strong" style="margin-top:6px;">${summary}</div>
            </div>
          </div>
          <div class="miniRow noPrint">
            <button class="miniBtn" data-act="load" data-id="${item.id}">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="miniBtn" data-act="copy" data-id="${item.id}">ë³µì‚¬</button>
            <button class="miniBtn" data-act="del" data-id="${item.id}">ì‚­ì œ</button>
          </div>
        `;
        wrap.appendChild(el);
      });

      // âœ… ë²„íŠ¼ ë™ì‘(ë¶ˆëŸ¬ì˜¤ê¸°/ë³µì‚¬/ì‚­ì œ) ì´ë²¤íŠ¸ ìœ„ì„
      wrap.onclick = async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        const list2 = loadHistory();
        const found = list2.find(x => x && x.id === id);
        if (!found) return;

        if (act === "load"){
          fillFormFrom(found);
        } else if (act === "del"){
          deleteOne(id);
        } else if (act === "copy"){
          const text = buildText(found);
          try{
            await navigator.clipboard.writeText(text);
            alert("ë³µì‚¬ ì™„ë£Œ!");
          }catch(e2){
            alert("ìë™ ë³µì‚¬ê°€ ë§‰í˜”ì–´. ë¶ˆëŸ¬ì˜¤ê¸° í›„ ê²°ê³¼ì°½ì„ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì¤˜.");
          }
        }
      };
    }

    function clampDivide(v){
      if (!Number.isFinite(v)) v = 4.5;
      if (v < 0.5) v = 0.5;
      v = Math.round(v * 2) / 2;
      return v;
    }
    function stepDivide(delta){
      if (locked) return;
      const cur = num($("divideBy").value) || 4.5;
      const next = clampDivide(cur + delta);
      $("divideBy").value = next;
      if (lastCalc) calculate();
    }

    /* âœ… ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ë™ì‘: í™•ì¸ì°½ â†’ ëˆ„ì ì„ ì´ì „ìœ¼ë¡œ í™•ì •, ì´ë²ˆì€ 0 */
    function refreshTotals(){
      const ok = confirm("ì •ë§ ìƒˆë¡œê³ ì¹¨í• ê¹Œìš”?");
      if (!ok) return;

      const t = loadTotals();

      /* âœ… (ì¶”ê°€) ìƒˆë¡œê³ ì¹¨ â€˜ì§ì „â€™ ê°’ì„ ë˜ëŒë¦¬ê¸°ìš©ìœ¼ë¡œ ë°±ì—… */
      localStorage.setItem(TOTALS_BACKUP_KEY, JSON.stringify(t));

      const nextPrev = (t.prev || 0) + (t.curr || 0);
      const nextCurr = 0;

      saveTotals(nextPrev, nextCurr);
      setTotalsUI(nextPrev, nextCurr);
    }

    $("calcBtn").addEventListener("click", calculate);
    $("copyBtn").addEventListener("click", copyKakao);
    $("saveBtn").addEventListener("click", saveCurrent);
    $("clearAllBtn").addEventListener("click", clearAll);

    $("pdfBtn").addEventListener("click", savePDF);

    $("pngBtn").addEventListener("click", savePNG);
    $("kakaoImgBtn").addEventListener("click", shareToKakaoAsFile);

    $("divDownBtn").addEventListener("click", ()=> stepDivide(-0.5));
    $("divUpBtn").addEventListener("click", ()=> stepDivide(+0.5));
    $("divideBy").addEventListener("change", ()=>{
      if (locked) return;
      $("divideBy").value = clampDivide(num($("divideBy").value) || 4.5);
      if (lastCalc) calculate();
    });

    ["memo","kg1","price1","kg2","price2","iceBoxes","iceUnit","fuelQty","fuelUnit","food","divideBy"].forEach(id=>{
      $(id).addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !locked) calculate(); });
    });

    attachCommaInput($("price1"));
    attachCommaInput($("price2"));
    attachCommaInput($("iceUnit"));
    attachCommaInput($("fuelUnit"));
    attachCommaInput($("food"));

    /* âœ… ìƒë‹¨ ì´í•© ì…ë ¥ë„ ì½¤ë§ˆ ë¶™ì´ê³ , ìˆ˜ì • ì €ì¥ */
    attachCommaInput($("prevTotal"));
    attachCommaInput($("currTotal"));
    $("prevTotal").addEventListener("blur", syncTotalsFromInputs);
    $("currTotal").addEventListener("blur", syncTotalsFromInputs);

    $("refreshTotalsBtn").addEventListener("click", refreshTotals);

    /* âœ… (ì¶”ê°€) ì´ì „ê°’ ë˜ëŒë¦¬ê¸° ë²„íŠ¼ */
    $("restoreTotalsBtn").addEventListener("click", restorePreviousTotals);

    renderHistory();

    /* âœ… ì²« ë¡œë“œì‹œ ì €ì¥ëœ ì´í•©ì„ ë³µì› */
    const t0 = loadTotals();
    setTotalsUI(t0.prev, t0.curr);

    $("divideBy").value = 4.5;
  </script>
</body>
</html>
