<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>낙지잡이</title>

  <!-- PWA(홈화면 추가) 기본 -->
  <meta name="theme-color" content="#0a84ff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <style>
    :root{
      --bg:#f2f2f7;
      --text:#111;
      --card:#f5f5f7;
      --card2:#fff;
      --line:#e5e5ea;
      --muted:#666;
      --muted2:#777;
      --primary:#007aff;
      --secondary:#111;
      --ghostBg:#fff;
      --ghostLine:#d1d1d6;
      --tagBg:#f2f2f7;
      --tagLine:#e5e5ea;
      --danger:#ff3b30;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#000;
        --text:#f5f5f7;
        --card:#101012;
        --card2:#16161a;
        --line:#2c2c2e;
        --muted:#a1a1a6;
        --muted2:#8e8e93;
        --primary:#0a84ff;
        --secondary:#f5f5f7;
        --ghostBg:#1c1c1e;
        --ghostLine:#3a3a3c;
        --tagBg:#1c1c1e;
        --tagLine:#3a3a3c;
        --danger:#ff453a;
      }
    }

    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 740px;
      margin: 22px auto;
      padding: 0 14px;
      line-height: 1.6;
      background: var(--bg);
      color: var(--text);
    }
    h1{ font-size: 22px; text-align:center; margin: 8px 0 14px; }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom: 12px;
    }
    .cardInner{
      background: var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }

    .titleSm{ font-weight:700; margin-top:8px; }
    .sectionTitle{ font-size:15px; font-weight:700; margin: 2px 0 8px; }

    label{ display:block; margin-top:10px; font-size:14px; color:var(--text); }
    input, select{
      width:100%;
      padding:10px;
      margin-top:6px;
      border:1px solid var(--ghostLine);
      border-radius:12px;
      font-size:16px;
      background: var(--ghostBg);
      color: var(--text);
      outline:none;
    }
    input:disabled{ opacity:0.6; }

    .row{ display:flex; gap:10px; }
    .row > div{ flex:1; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    button{
      width:100%;
      padding:12px;
      margin-top:12px;
      border:0;
      border-radius:14px;
      font-size:16px;
      background: var(--ghostBg);
      color: var(--text);
    }
    button:disabled{ opacity:0.6; }

    .primary{ background: var(--primary); color:#fff; }
    .secondary{ background: var(--secondary); color:#fff; }
    @media (prefers-color-scheme: dark){
      .secondary{ background: #f5f5f7; color:#000; }
    }

    .ghost{ background: var(--ghostBg); border:1px solid var(--ghostLine); }

    .btnRow{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .btnRow button{ margin-top:0; width:100%; }
    .btnRow.three button{ width: calc(33.333% - 6.66px); }
    .btnRow.two button{ width: calc(50% - 5px); }

    .result{
      margin-top:14px;
      white-space:pre-line;
      background: var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      user-select:text;
      -webkit-user-select:text;
    }

    .muted{ color:var(--muted2); font-size:12px; }
    .strong{ font-weight:700; }

    .historyList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .historyItem{
      background: var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .historyTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .tag{
      font-size:12px;
      color:var(--text);
      background: var(--tagBg);
      border:1px solid var(--tagLine);
      padding:4px 8px;
      border-radius:999px;
      display:inline-block;
      max-width: 72%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .miniBtn{
      font-size:13px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--ghostLine);
      background: var(--ghostBg);
      width:auto;
      margin:0;
    }
    .miniRow{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:10px;
      flex-wrap:wrap;
    }

    /* 개인당 강조 모드 */
    .bigPerShare .result{ font-size:15px; }
    .bigPerShare .perShareLine{
      font-size:22px;
      font-weight:900;
      line-height:1.3;
      padding-top:6px;
    }

    /* 잠금 상태 UI */
    .lockedBadge{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--card2);
      font-size:12px;
      color: var(--muted);
    }

    /* 개인당(÷) 스텝퍼 */
    .stepper{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:6px;
    }
    .stepBtn{
      width:44px;
      min-width:44px;
      padding:10px 0;
      margin:0;
      border-radius:12px;
      border:1px solid var(--ghostLine);
      background: var(--ghostBg);
      font-size:18px;
      line-height:1;
    }
    .stepper input{
      margin-top:0;
      text-align:center;
      font-weight:700;
    }

    /* ✅ 상단 1줄: 개인당 총합 */
    .topTotalLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .topTotalLabel{ font-weight:800; }
    .topTotalValue{
      font-weight:900;
      color: var(--danger);
      font-size:20px;
      white-space:nowrap;
    }

    /* 인쇄/PDF */
    @media print{
      body{ max-width:none; margin:0; padding:0; }
      .noPrint{ display:none !important; }
      .card{ border:none; background:transparent; }
      .result{ border:1px solid #999; }
    }
  </style>
</head>

<body>
  <h1>낙지잡이</h1>

  <!-- ✅ (추가) 저장된 정산 기준: 날짜별 개인당 누적 → 그걸 전부 더한 개인당 총합 1줄 -->
  <div class="card">
    <div class="topTotalLine">
      <div class="topTotalLabel">개인당 총합</div>
      <div class="topTotalValue" id="sumAllPer">0원</div>
    </div>

    <div style="margin-top:10px; display:flex; justify-content:space-between; gap:10px; align-items:center;">
      <div class="muted" id="calcTime"></div>
    </div>

    <!-- ✅ 사진에 나온 버튼영역(최근/크게보기/잠금) 삭제 -->
  </div>

  <!-- 입력 카드 -->
  <div class="card" id="inputCard">
    <div class="row">
      <div>
        <label>정산 메모(선택)</label>
        <input type="text" id="memo" placeholder="예: 12/30 여수 1차" />
      </div>
    </div>

    <div class="titleSm">낙지 1</div>
    <div class="row">
      <div>
        <label>낙지1 (kg)</label>
        <input type="number" id="kg1" inputmode="decimal" placeholder="예: 12" />
      </div>
      <div>
        <label>단가1 (원)</label>
        <input type="text" id="price1" inputmode="numeric" placeholder="예: 35,000" />
      </div>
    </div>

    <div class="titleSm">낙지 2</div>
    <div class="row">
      <div>
        <label>낙지2 (kg)</label>
        <input type="number" id="kg2" inputmode="decimal" placeholder="예: 8" />
      </div>
      <div>
        <label>단가2 (원)</label>
        <input type="text" id="price2" inputmode="numeric" placeholder="예: 40,000" />
      </div>
    </div>

    <div class="titleSm">경비</div>

    <div class="row">
      <div>
        <label>입감 (박스)</label>
        <input type="number" id="iceBoxes" inputmode="numeric" placeholder="예: 2" />
      </div>
      <div>
        <label>입감 단가 (원)</label>
        <input type="text" id="iceUnit" inputmode="numeric" value="60,000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>기름 수량</label>
        <input type="number" id="fuelQty" inputmode="decimal" placeholder="예: 3" />
      </div>
      <div>
        <label>기름 단가 (원)</label>
        <input type="text" id="fuelUnit" inputmode="numeric" value="200,000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>부식 (원)</label>
        <input type="text" id="food" inputmode="numeric" placeholder="예: 50,000" />
      </div>
      <div>
        <label>개인당 나누기</label>
        <div class="stepper noPrint">
          <button class="stepBtn" id="divDownBtn" type="button">−</button>
          <input type="number" id="divideBy" inputmode="decimal" step="0.5" value="4.5" />
          <button class="stepBtn" id="divUpBtn" type="button">+</button>
        </div>
      </div>
    </div>

    <button class="primary noPrint" id="calcBtn">계산하기</button>

    <div class="btnRow three noPrint">
      <button class="secondary" id="copyBtn">카톡으로 보내기(복사)</button>
      <button class="ghost" id="saveBtn">이 정산 저장</button>
      <button class="ghost" id="pngBtn">이미지 저장(PNG)</button>
    </div>

    <div class="btnRow two noPrint">
      <button class="ghost" id="kakaoImgBtn">카톡으로 이미지 보내기</button>
      <button class="ghost" id="pdfBtn">PDF 저장(인쇄)</button>
    </div>

    <div class="btnRow two noPrint">
      <button class="ghost" id="xlsxBtn">엑셀(.xlsx) 내보내기</button>
      <button class="ghost" id="imgCopyBtn">이미지 링크 열기(폴백)</button>
    </div>

    <div class="btnRow two noPrint">
      <button class="ghost" id="backupBtn">백업(JSON 저장)</button>
      <button class="ghost" id="restoreBtn">복원(JSON 불러오기)</button>
    </div>

    <input type="file" id="restoreFile" accept="application/json" style="display:none;" />

    <div class="result" id="result">값 입력 → 계산하기</div>
  </div>

  <!-- 저장 히스토리 -->
  <div class="card">
    <div class="historyTop noPrint">
      <div>
        <div class="sectionTitle">저장된 정산</div>
        <div class="muted">※ 최대 50개까지 저장</div>
      </div>
      <button class="miniBtn" id="clearAllBtn">전체 삭제</button>
    </div>

    <div class="historyList" id="historyList">
      <div class="muted">아직 저장된 정산이 없어.</div>
    </div>
  </div>

  <!-- 라이브러리: XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- 라이브러리: PNG 캡처 -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    const STORAGE_KEY = "nakji_settlements_final_split_v1";
    let kakaoText = "";
    let lastCalc = null;

    let locked = false;
    let lastImageDataUrl = "";

    function num(v){
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    }
    function uncomma(v){
      const s = String(v ?? "").replace(/,/g, "").trim();
      if (!s) return 0;
      const clean = s.replace(/[^\d.-]/g, "");
      return Number(clean) || 0;
    }
    function won(x){
      return Math.round(x).toLocaleString("ko-KR") + "원";
    }
    function nfmtInt(x){
      return Math.round(x).toLocaleString("ko-KR");
    }

    function attachCommaInput(el){
      if (!el) return;
      el.addEventListener("input", () => {
        if (locked) return;
        const raw = el.value.replace(/,/g, "").replace(/[^\d]/g, "");
        if (!raw) { el.value = ""; return; }
        el.value = Number(raw).toLocaleString("ko-KR");
      });
      el.addEventListener("blur", () => {
        if (locked) return;
        const raw = el.value.replace(/,/g, "").replace(/[^\d]/g, "");
        if (!raw) { el.value = ""; return; }
        el.value = Number(raw).toLocaleString("ko-KR");
      });
    }

    function nowLabel(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }
    function nowYMD(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}/${mm}/${dd}`;
    }

    // ✅ 날짜키 추출: memo에 날짜 있으면 그걸 우선, 없으면 createdAt 날짜
    function extractDateKey(item){
      const memo = String(item?.memo || "");
      let m = memo.match(/(\d{4})[\/-](\d{2})[\/-](\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;

      const createdAt = String(item?.createdAt || "");
      m = createdAt.match(/(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;

      return "기타";
    }

    // ✅ 저장된 정산: 날짜별 개인당 합계로 먼저 묶고 → 그걸 전부 더한 총합
    function calcAllPerShareTotalFromHistory(){
      const list = loadHistory();
      const byDate = {};
      list.forEach(item => {
        const key = extractDateKey(item);
        const per = Number(item?.perShareRounded ?? item?.perShare ?? 0) || 0;
        byDate[key] = (byDate[key] || 0) + per;
      });

      let total = 0;
      Object.keys(byDate).forEach(k => total += byDate[k] || 0);
      return total;
    }

    function updateAllPerShareTotal(){
      $("sumAllPer").innerText = won(calcAllPerShareTotalFromHistory());
    }

    function ensureMemoDefault(){
      const m = $("memo").value.trim();
      if (!m) $("memo").value = `${nowYMD()} 정산`;
    }

    // ✅ 결과 문구 형식 기능 삭제: buildText는 1가지 고정(카톡용)
    function buildText(calc){
      const memoLine = calc.memo ? `메모: ${calc.memo}\n` : "";
      const timeLine = calc.createdAt ? `시간: ${calc.createdAt}\n` : "";
      const perLine = `개인당: 최종합계 ÷ ${calc.divideBy} = ${won(calc.perShareRounded)}`;

      return `[낙지잡이 정산]
${timeLine}${memoLine}
1) 낙지: ${calc.kg1}kg × ${nfmtInt(calc.price1)}원 = ${won(calc.total1)}
2) 낙지: ${calc.kg2}kg × ${nfmtInt(calc.price2)}원 = ${won(calc.total2)}
낙지 총합: ${won(calc.nakjiTotal)}

[경비]
입감: ${calc.iceBoxes}박스 × ${nfmtInt(calc.iceUnit)}원 = ${won(calc.iceCost)}
기름값: ${calc.fuelQty} × ${nfmtInt(calc.fuelUnit)}원 = ${won(calc.fuelCost)}
수협수수료: 낙지 총합의 5% = ${won(calc.coopFee)}
부식: ${won(calc.food)}
총 경비: ${won(calc.totalCost)}

최종합계: ${won(calc.finalTotal)}
${perLine}`;
    }

    function renderResult(calc){
      kakaoText = buildText(calc);

      const perLine = `개인당: 최종합계 ÷ ${calc.divideBy} = ${won(calc.perShareRounded)}`;
      $("result").innerHTML = "";

      const pre = document.createElement("div");
      pre.style.whiteSpace = "pre-line";
      pre.textContent = kakaoText.replace(perLine, "").trimEnd() + "\n";
      $("result").appendChild(pre);

      const perDiv = document.createElement("div");
      perDiv.className = "perShareLine";
      perDiv.textContent = perLine;
      $("result").appendChild(perDiv);
    }

    function calculate(){
      ensureMemoDefault();
      const memo = $("memo").value.trim();

      const kg1 = num($("kg1").value);
      const price1 = uncomma($("price1").value);
      const total1 = kg1 * price1;

      const kg2 = num($("kg2").value);
      const price2 = uncomma($("price2").value);
      const total2 = kg2 * price2;

      const nakjiTotal = total1 + total2;

      const iceBoxes = num($("iceBoxes").value);
      const iceUnit  = uncomma($("iceUnit").value) || 0;
      const iceCost  = iceBoxes * iceUnit;

      const fuelQty  = num($("fuelQty").value);
      const fuelUnit = uncomma($("fuelUnit").value) || 0;
      const fuelCost = fuelQty * fuelUnit;

      const food = uncomma($("food").value);
      const divideBy = num($("divideBy").value) || 1;

      const feeRate = 0.05;
      const coopFee = nakjiTotal * feeRate;

      const totalCost = iceCost + fuelCost + coopFee + food;
      const finalTotal = nakjiTotal - totalCost;
      const perShare = finalTotal / divideBy;

      // ✅ 개인당 반올림 기능 삭제: 그대로 사용
      const perShareRounded = perShare;

      const id = (crypto && crypto.randomUUID)
        ? crypto.randomUUID()
        : (String(Date.now()) + "_" + Math.random().toString(16).slice(2));

      lastCalc = {
        id,
        createdAt: nowLabel(),
        memo,
        kg1, price1, total1,
        kg2, price2, total2,
        nakjiTotal,
        iceBoxes, iceUnit, iceCost,
        fuelQty, fuelUnit, fuelCost,
        food,
        feeRate, coopFee,
        totalCost,
        finalTotal,
        divideBy,
        perShare,
        perShareRounded
      };

      $("calcTime").innerText = lastCalc.createdAt ? `계산 시각: ${lastCalc.createdAt.split(" ")[1]}` : "";

      renderResult(lastCalc);
      renderHistory();
    }

    async function copyKakao(){
      if (!lastCalc) calculate();
      if (!lastCalc) return;

      try{
        await navigator.clipboard.writeText(kakaoText);
        alert("복사 완료!");
      }catch(e){
        alert("자동 복사가 막혔어. 결과창을 길게 눌러서 복사해줘.");
      }
    }

    function savePDF(){
      if (!lastCalc) calculate();
      window.print();
    }

    function exportXLSX(){
      if (!lastCalc) calculate();
      if (!lastCalc) return;

      const rows = [
        ["항목", "수량", "단가(원)", "금액(원)"],
        ["낙지1", lastCalc.kg1, lastCalc.price1, Math.round(lastCalc.total1)],
        ["낙지2", lastCalc.kg2, lastCalc.price2, Math.round(lastCalc.total2)],
        ["낙지총합", "", "", Math.round(lastCalc.nakjiTotal)],
        ["", "", "", ""],
        ["입감(박스)", lastCalc.iceBoxes, lastCalc.iceUnit, Math.round(lastCalc.iceCost)],
        ["기름", lastCalc.fuelQty, lastCalc.fuelUnit, Math.round(lastCalc.fuelCost)],
        ["수협수수료(5%)", "", "", Math.round(lastCalc.coopFee)],
        ["부식", "", "", Math.round(lastCalc.food)],
        ["총경비", "", "", Math.round(lastCalc.totalCost)],
        ["", "", "", ""],
        ["최종합계", "", "", Math.round(lastCalc.finalTotal)],
        ["개인당", lastCalc.divideBy, "", Math.round(lastCalc.perShareRounded)],
      ];

      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws["!cols"] = [{wch:18},{wch:10},{wch:14},{wch:14}];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "정산");

      const nameSafe = (lastCalc.memo || "정산").replace(/[\\/:*?"<>|]/g, "_").slice(0, 30);
      XLSX.writeFile(wb, `낙지정산_${nameSafe}.xlsx`);
    }

    function makeCaptureTarget(){
      const target = document.createElement("div");
      target.style.padding = "14px";
      target.style.background = getComputedStyle(document.body).backgroundColor;

      // ✅ 기존 summaryGrid clone 대신: 맨 위 카드(개인당 총합 카드)를 통째로 캡처
      const topClone = document.querySelector(".card").cloneNode(true);
      const inputClone = $("inputCard").cloneNode(true);

      topClone.querySelectorAll(".noPrint").forEach(el=>el.remove());
      inputClone.querySelectorAll(".noPrint").forEach(el=>el.remove());

      const rf = inputClone.querySelector("#restoreFile");
      if (rf) rf.remove();

      target.appendChild(topClone);
      target.appendChild(inputClone);

      target.style.position = "fixed";
      target.style.left = "-99999px";
      target.style.top = "0";
      document.body.appendChild(target);
      return target;
    }

    async function buildCanvas(){
      if (!lastCalc) calculate();
      if (!lastCalc) return null;

      const target = makeCaptureTarget();
      try{
        const canvas = await html2canvas(target, {
          scale: 2,
          backgroundColor: getComputedStyle(document.body).backgroundColor,
          useCORS: true
        });
        return canvas;
      } finally {
        target.remove();
      }
    }

    function safeFilename(){
      const nameSafe = (lastCalc?.memo || "정산")
        .replace(/[\\/:*?"<>|]/g, "_")
        .slice(0, 30);
      return `낙지정산_${nameSafe}.png`;
    }

    async function savePNG(){
      const canvas = await buildCanvas();
      if (!canvas) return;

      const filename = safeFilename();
      lastImageDataUrl = canvas.toDataURL("image/png");

      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      if (isIOS){
        const w = window.open();
        if (w){
          w.document.write(`<img src="${lastImageDataUrl}" style="max-width:100%;height:auto;">`);
          w.document.title = filename;
        } else {
          window.location.href = lastImageDataUrl;
        }
        return;
      }

      const a = document.createElement("a");
      a.href = lastImageDataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function shareToKakaoAsFile(){
      const canvas = await buildCanvas();
      if (!canvas) return;

      const filename = safeFilename();

      if (navigator.share && canvas.toBlob){
        const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
        if (blob){
          const file = new File([blob], filename, { type:"image/png" });

          if (!navigator.canShare || navigator.canShare({ files:[file] })){
            try{
              await navigator.share({
                title: "낙지잡이 정산",
                text: "정산 이미지 파일",
                files: [file]
              });
              return;
            }catch(e){}
          }
        }
      }

      const dataUrl = canvas.toDataURL("image/png");
      lastImageDataUrl = dataUrl;
      const w = window.open();
      if (w){
        w.document.write(`<img src="${dataUrl}" style="max-width:100%;height:auto;">`);
        w.document.title = filename;
      } else {
        window.location.href = dataUrl;
      }
      alert("기기/브라우저 제한으로 파일 공유가 안 돼서, 이미지 탭을 열었어. 공유에서 카톡을 선택해줘(링크로 갈 수도 있어).");
    }

    function openLastImage(){
      if (!lastImageDataUrl){
        alert("아직 만든 이미지가 없어. 먼저 이미지 저장(PNG) 또는 카톡으로 이미지 보내기를 눌러줘.");
        return;
      }
      const w = window.open();
      if (w){
        w.document.write(`<img src="${lastImageDataUrl}" style="max-width:100%;height:auto;">`);
      } else {
        window.location.href = lastImageDataUrl;
      }
    }

    function loadHistory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }
    function saveHistory(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function saveCurrent(){
      if (!lastCalc) calculate();
      if (!lastCalc) return;

      const list = loadHistory();
      list.unshift(lastCalc);
      saveHistory(list.slice(0, 50));
      renderHistory();
      updateAllPerShareTotal();
      alert("저장 완료!");
    }

    function deleteOne(id){
      const list = loadHistory().filter(x => x && x.id !== id);
      saveHistory(list);
      renderHistory();
      updateAllPerShareTotal();
    }

    function clearAll(){
      const ok = confirm("저장된 정산을 전부 삭제할까?");
      if (!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
      updateAllPerShareTotal();
    }

    function fillFormFrom(calc){
      $("memo").value = calc.memo || "";
      $("kg1").value = (calc.kg1 ?? "");
      $("price1").value = nfmtInt(calc.price1 ?? 0);

      $("kg2").value = (calc.kg2 ?? "");
      $("price2").value = nfmtInt(calc.price2 ?? 0);

      $("iceBoxes").value = (calc.iceBoxes ?? "");
      $("iceUnit").value = nfmtInt(calc.iceUnit ?? 0);

      $("fuelQty").value = (calc.fuelQty ?? "");
      $("fuelUnit").value = nfmtInt(calc.fuelUnit ?? 0);

      $("food").value = nfmtInt(calc.food ?? 0);
      $("divideBy").value = (calc.divideBy ?? 4.5);

      const per = (calc.perShareRounded ?? calc.perShare ?? 0);

      lastCalc = {
        ...calc,
        perShareRounded: per,
        totalCost: calc.totalCost ?? (calc.iceCost + calc.fuelCost + (calc.nakjiTotal*0.05) + calc.food),
        finalTotal: calc.finalTotal ?? (calc.nakjiTotal - (calc.iceCost + calc.fuelCost + (calc.nakjiTotal*0.05) + calc.food)),
      };

      $("calcTime").innerText = lastCalc.createdAt ? `계산 시각: ${String(lastCalc.createdAt).split(" ")[1] || ""}` : "";

      renderResult(lastCalc);
      updateAllPerShareTotal();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function renderHistory(){
      const list = loadHistory();
      const wrap = $("historyList");

      if (!list.length){
        wrap.innerHTML = `<div class="muted">아직 저장된 정산이 없어.</div>`;
        return;
      }

      wrap.innerHTML = "";
      list.forEach((item) => {
        const title = item.memo ? item.memo : "정산";
        const time = item.createdAt ? item.createdAt : "";
        const per = (item.perShareRounded ?? item.perShare ?? 0);
        const summary = `낙지총합 ${won(item.nakjiTotal)} / 최종 ${won(item.finalTotal)} / 개인당 ${won(per)}`;

        const el = document.createElement("div");
        el.className = "historyItem";
        el.innerHTML = `
          <div class="historyTop">
            <div>
              <div class="tag">${title}</div>
              <div class="muted" style="margin-top:6px;">${time}</div>
              <div class="strong" style="margin-top:6px;">${summary}</div>
            </div>
          </div>
          <div class="miniRow noPrint">
            <button class="miniBtn" data-act="load" data-id="${item.id}">불러오기</button>
            <button class="miniBtn" data-act="copy" data-id="${item.id}">복사</button>
            <button class="miniBtn" data-act="del" data-id="${item.id}">삭제</button>
          </div>
        `;
        wrap.appendChild(el);
      });

      wrap.onclick = async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        const list2 = loadHistory();
        const found = list2.find(x => x && x.id === id);
        if (!found) return;

        if (act === "load"){
          fillFormFrom(found);
        } else if (act === "del"){
          deleteOne(id);
        } else if (act === "copy"){
          const text = buildText(found);
          try{
            await navigator.clipboard.writeText(text);
            alert("복사 완료!");
          }catch(e2){
            alert("자동 복사가 막혔어. 불러오기 후 결과창을 길게 눌러 복사해줘.");
          }
        }
      };
    }

    function clampDivide(v){
      if (!Number.isFinite(v)) v = 4.5;
      if (v < 0.5) v = 0.5;
      v = Math.round(v * 2) / 2;
      return v;
    }
    function stepDivide(delta){
      if (locked) return;
      const cur = num($("divideBy").value) || 4.5;
      const next = clampDivide(cur + delta);
      $("divideBy").value = next;
      if (lastCalc) calculate();
    }

    $("calcBtn").addEventListener("click", calculate);
    $("copyBtn").addEventListener("click", copyKakao);
    $("saveBtn").addEventListener("click", saveCurrent);
    $("clearAllBtn").addEventListener("click", clearAll);

    $("pdfBtn").addEventListener("click", savePDF);
    $("xlsxBtn").addEventListener("click", exportXLSX);

    $("pngBtn").addEventListener("click", savePNG);
    $("kakaoImgBtn").addEventListener("click", shareToKakaoAsFile);
    $("imgCopyBtn").addEventListener("click", openLastImage);

    $("backupBtn").addEventListener("click", backupJSON);
    $("restoreBtn").addEventListener("click", restoreJSON);
    $("restoreFile").addEventListener("change", (e)=> handleRestoreFile(e.target.files && e.target.files[0]));

    $("divDownBtn").addEventListener("click", ()=> stepDivide(-0.5));
    $("divUpBtn").addEventListener("click", ()=> stepDivide(+0.5));
    $("divideBy").addEventListener("change", ()=>{
      if (locked) return;
      $("divideBy").value = clampDivide(num($("divideBy").value) || 4.5);
      if (lastCalc) calculate();
    });

    ["memo","kg1","price1","kg2","price2","iceBoxes","iceUnit","fuelQty","fuelUnit","food","divideBy"].forEach(id=>{
      $(id).addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !locked) calculate(); });
    });

    attachCommaInput($("price1"));
    attachCommaInput($("price2"));
    attachCommaInput($("iceUnit"));
    attachCommaInput($("fuelUnit"));
    attachCommaInput($("food"));

    renderHistory();
    updateAllPerShareTotal();

    $("divideBy").value = 4.5;

    function backupJSON(){
      const list = loadHistory();
      const blob = new Blob([JSON.stringify(list, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `낙지정산_백업_${nowYMD().replaceAll("/","-")}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function restoreJSON(){
      $("restoreFile").click();
    }
    function handleRestoreFile(file){
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(String(reader.result || "[]"));
          if (!Array.isArray(data)) throw new Error("형식 오류");
          saveHistory(data.slice(0, 50));
          renderHistory();
          updateAllPerShareTotal();
          alert("복원 완료!");
        }catch(e){
          alert("복원 실패: JSON 파일이 올바르지 않아.");
        }
      };
      reader.readAsText(file, "utf-8");
    }
  </script>
</body>
</html>
